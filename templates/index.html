<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAPSWORK</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Application Stylesheets -->
    <link rel="stylesheet" href="/static/css/main.css">
    
    <!-- Legacy Script (to be refactored) -->
    <script src="/static/fix_removeAISuggestion.js"></script>
</head>

<body>
    <!-- Board Menu Container -->
    <div id="board-menu-container" style="position: absolute; top: 16px; right: 24px; z-index: 10;">
        <span id="board-menu-icon" style="font-size: 1.8em; cursor: pointer; user-select: none;" title="Board options">
            <i class="fa fa-info-circle"></i>
        </span>
        <div id="board-menu-dropdown" style="display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-width:180px;z-index:2000;">
            <a id="open-board" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#333;border-bottom:1px solid #eee;">
                <i class="fa fa-folder-open" style="margin-right:0.5em;"></i>Open Board
            </a>
            <a id="create-board" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#333;border-bottom:1px solid #eee;">
                <i class="fa fa-plus" style="margin-right:0.5em;"></i>Create Board
            </a>
            <a id="export-data" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#333;border-bottom:1px solid #eee;">
                <i class="fa fa-download" style="margin-right:0.5em;"></i>Export Data
            </a>
            <a id="import-data" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#333;border-bottom:1px solid #eee;">
                <i class="fa fa-upload" style="margin-right:0.5em;"></i>Import Data
            </a>
            <a id="delete-board" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#c00;border-bottom:1px solid #eee;">
                <i class="fa fa-trash" style="margin-right:0.5em;"></i>Delete Board
            </a>
            <a id="reset-conversation-main" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#333;border-bottom:1px solid #eee;">
                <i class="fa fa-refresh" style="margin-right:0.5em;"></i>Reset Conversation
            </a>
            <a id="help-link" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#333;">
                <i class="fa fa-question-circle" style="margin-right:0.5em;"></i>Help
            </a>
            <a id="export-cpf-link" href="#" style="display:block;padding:0.7em 1em;text-decoration:none;color:#333;">
                <i class="fa fa-file-text" style="margin-right:0.5em;"></i>Export C.P.F.
            </a>
        </div>
    </div>

    <!-- Board Creation Modal -->
    <div id="create-board-modal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2em;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:400px;width:90%;margin:auto;">
            <h3 style="margin:0 0 1em 0;">Create New Board</h3>
            <input id="new-board-name" type="text" placeholder="Board name" style="width:100%;padding:0.6em;border:1px solid #ccc;border-radius:5px;font-size:1em;margin-bottom:1em;">
            <div style="display:flex;gap:0.5em;justify-content:flex-end;">
                <button id="modal-create-board-btn" style="background:#007bff;color:#fff;padding:0.6em 1.2em;border:none;border-radius:5px;font-size:1em;cursor:pointer;">Create</button>
                <button id="modal-cancel-board-btn" style="background:#eee;color:#444;padding:0.6em 1.2em;border:none;border-radius:5px;font-size:1em;cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Open Board Modal -->
    <div id="open-board-modal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2em;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:500px;width:90%;margin:auto;">
            <h3 style="margin:0 0 1em 0;">Select Board</h3>
            <div id="board-list" style="max-height:300px;overflow-y:auto;margin-bottom:1em;">
                <!-- Board list will be populated here -->
            </div>
            <div style="display:flex;gap:0.5em;justify-content:flex-end;">
                <button id="close-board-modal" style="background:#eee;color:#444;padding:0.6em 1.2em;border:none;border-radius:5px;font-size:1em;cursor:pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header>
        <h1>GAPS Facilitator</h1>
        <p>Goal-Analysis-Plan-Status Framework for Problem Solving</p>
        {% if board %}
        <div style="text-align: center; margin: 0.3rem 0; padding: 0.3rem; font-size: 0.9rem; font-weight: 600; color: #007bff; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; display: inline-block;">
            üìã {{ board.title or board.name or 'Unnamed Board' }}
        </div>
        {% else %}
        <div style="text-align: center; margin: 0.3rem 0; padding: 0.3rem; font-size: 0.9rem; font-weight: 600; color: #6c757d; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; display: inline-block;">
            üìã No Board Selected
        </div>
        {% endif %}
    </header>

    <!-- Main Content -->
    <main>
        <!-- Add Thought Section -->
        <div class="add-thought">
            <input id="new-thought-input" type="text" placeholder="What's on your mind? (AI will help organize your thoughts)" style="flex:1;">
            <select id="new-thought-quadrant">
                <option value="auto">AI Decide</option>
                <option value="status">Status</option>
                <option value="goal">Goal</option>
                <option value="analysis">Analysis</option>
                <option value="plan">Plan</option>
            </select>
            <button id="add-thought-btn">Add</button>
            <button class="voice-btn" id="voice-btn" title="Voice input">üé§</button>
        </div>

        <!-- Interactive Mode Link -->
        <div style="text-align:center;margin-bottom:2rem;">
            <a id="interactive-gaps-link" href="#" style="background:#007bff;color:#fff;padding:0.8rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:600;display:inline-block;">
                <i class="fa fa-comments" style="margin-right:0.5rem;"></i>Interactive Mode
            </a>
        </div>

        <!-- Quadrants Grid -->
        <div class="quadrants">
            <!-- Status Quadrant -->
            <div class="quadrant" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)" ondrop="dropThought(event, 'status')">
                <h2><i class="fa fa-info-circle"></i> Status</h2>
                <ul id="status-list" class="thought-list">
                    {% for thought in thoughts.status %}
                        <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ thought.id }}')" ondragend="clearTrashHighlight()" data-thought-id="{{ thought.id }}" data-quadrant="status">
                            <span class="thought-content">{{ thought.content }}</span>
                            <div class="thought-controls">
                                <button onclick="editThought({{ thought.id }}, '{{ thought.content|e }}', this)" title="Edit">‚úèÔ∏è</button>
                                <select onchange="moveThought({{ thought.id }}, this.value, this)">
                                    <option value="">Move to...</option>
                                    <option value="goal">Goal</option>
                                    <option value="analysis">Analysis</option>
                                    <option value="plan">Plan</option>
                                </select>
                                <button onclick="deleteThought({{ thought.id }}, this)" title="Delete">üóëÔ∏è</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Goal Quadrant -->
            <div class="quadrant" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)" ondrop="dropThought(event, 'goal')">
                <h2><i class="fa fa-bullseye"></i> Goal</h2>
                <ul id="goal-list" class="thought-list">
                    {% for thought in thoughts.goal %}
                        <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ thought.id }}')" ondragend="clearTrashHighlight()" data-thought-id="{{ thought.id }}" data-quadrant="goal">
                            <span class="thought-content">{{ thought.content }}</span>
                            <div class="thought-controls">
                                <button onclick="editThought({{ thought.id }}, '{{ thought.content|e }}', this)" title="Edit">‚úèÔ∏è</button>
                                <select onchange="moveThought({{ thought.id }}, this.value, this)">
                                    <option value="">Move to...</option>
                                    <option value="status">Status</option>
                                    <option value="analysis">Analysis</option>
                                    <option value="plan">Plan</option>
                                </select>
                                <button onclick="deleteThought({{ thought.id }}, this)" title="Delete">üóëÔ∏è</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Analysis Quadrant -->
            <div class="quadrant" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)" ondrop="dropThought(event, 'analysis')">
                <h2><i class="fa fa-search"></i> Analysis</h2>
                <ul id="analysis-list" class="thought-list">
                    {% for thought in thoughts.analysis %}
                        <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ thought.id }}')" ondragend="clearTrashHighlight()" data-thought-id="{{ thought.id }}" data-quadrant="analysis">
                            <span class="thought-content">{{ thought.content }}</span>
                            <div class="thought-controls">
                                <button onclick="editThought({{ thought.id }}, '{{ thought.content|e }}', this)" title="Edit">‚úèÔ∏è</button>
                                <select onchange="moveThought({{ thought.id }}, this.value, this)">
                                    <option value="">Move to...</option>
                                    <option value="status">Status</option>
                                    <option value="goal">Goal</option>
                                    <option value="plan">Plan</option>
                                </select>
                                <button onclick="deleteThought({{ thought.id }}, this)" title="Delete">üóëÔ∏è</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Plan Quadrant -->
            <div class="quadrant" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)" ondrop="dropThought(event, 'plan')">
                <h2><i class="fa fa-list"></i> Plan</h2>
                <ul id="plan-list" class="thought-list">
                    {% for thought in thoughts.plan %}
                        <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ thought.id }}')" ondragend="clearTrashHighlight()" data-thought-id="{{ thought.id }}" data-quadrant="plan">
                            <span class="thought-content">{{ thought.content }}</span>
                            <div class="thought-controls">
                                <button onclick="editThought({{ thought.id }}, '{{ thought.content|e }}', this)" title="Edit">‚úèÔ∏è</button>
                                <select onchange="moveThought({{ thought.id }}, this.value, this)">
                                    <option value="">Move to...</option>
                                    <option value="status">Status</option>
                                    <option value="goal">Goal</option>
                                    <option value="analysis">Analysis</option>
                                </select>
                                <button onclick="deleteThought({{ thought.id }}, this)" title="Delete">üóëÔ∏è</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </main>

    <!-- Interactive GAPS Modal -->
    <div id="interactive-gaps-modal" style="display:none;position:fixed;z-index:3000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
        <div id="interactive-gaps-modal-content" style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:500px;width:95%;margin:auto;display:flex;flex-direction:column;gap:1em;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:1em;">
                <h3 style="margin:0 0 0.5em 0;">Interactive GAPS Facilitator</h3>
                <div style="display:flex;align-items:center;gap:0.5em;">
                    <!-- Info Dropdown -->
                    <div style="position:relative;">
                        <button id="interactive-gaps-info" title="Options" style="background:none;border:none;font-size:1.2em;cursor:pointer;color:#888;line-height:1;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;">i</button>
                        <div id="interactive-gaps-info-dropdown" style="display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-width:160px;z-index:5000;">
                            <a href="#" id="reset-conversation" style="display:block;padding:0.5em 1em;text-decoration:none;color:#333;border-bottom:1px solid #eee;">Reset Conversation</a>
                        </div>
                    </div>
                    <!-- Minimize Button -->
                    <button id="interactive-gaps-minimize" title="Minimize" style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#888;line-height:1;">&#8211;</button>
                </div>
            </div>
            <div id="interactive-gaps-chat" style="height:220px;overflow-y:auto;background:#f8fafc;border-radius:8px;padding:1em;margin-bottom:1em;font-size:1.05em;">
            </div>
            <div style="display:flex;gap:0.5em;align-items:center;">
                <textarea id="interactive-gaps-input" placeholder="Type your response..." rows="4" style="flex:1;padding:0.7em 1em;border-radius:5px;border:1px solid #ccc;font-size:1em;resize:vertical;min-height:48px;max-height:180px;"></textarea>
                <button id="interactive-gaps-send" style="background:#007bff;color:#fff;border:none;padding:0.7em 1.2em;border-radius:5px;font-size:1em;cursor:pointer;align-self:flex-end;">Send</button>
            </div>
            <button id="interactive-gaps-close" style="background:#eee;color:#444;border:none;padding:0.5em 1em;border-radius:5px;font-size:0.9em;cursor:pointer;align-self:flex-end;">Close</button>
        </div>
    </div>
    
    <!-- Interactive Mode Minimized Icon -->
    <div id="interactive-gaps-minimized-icon" style="display:none;position:fixed;bottom:20px;left:20px;z-index:4000;background:#007bff;color:white;width:60px;height:60px;border-radius:50%;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2em;transition:all 0.3s ease;" title="Restore Interactive Mode">
        <i class="fas fa-comments"></i>
    </div>

    <!-- Help Overlay -->
    <div id="help-overlay" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:3000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:2em;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
            <h3 style="margin:0 0 1em 0;">GAPS Framework Help</h3>
            <div id="gaps-kb-content">
                <h4>What is GAPS?</h4>
                <p>GAPS is a problem-solving framework that organizes thoughts into four quadrants:</p>
                <ul>
                    <li><strong>Status:</strong> Current situation, facts, observations</li>
                    <li><strong>Goal:</strong> Desired outcomes, objectives, targets</li>
                    <li><strong>Analysis:</strong> Root causes, insights, understanding</li>
                    <li><strong>Plan:</strong> Actions, steps, solutions</li>
                </ul>
                <h4>How to Use</h4>
                <p>1. Add thoughts using the input field above</p>
                <p>2. Let AI automatically categorize them, or choose a specific quadrant</p>
                <p>3. Use Interactive Mode for guided problem-solving conversations</p>
                <p>4. Move thoughts between quadrants as your understanding evolves</p>
            </div>
            <button onclick="document.getElementById('help-overlay').style.display='none'" style="background:#007bff;color:#fff;border:none;padding:0.6em 1.2em;border-radius:5px;font-size:1em;cursor:pointer;margin-top:1em;">Close</button>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification"></div>

    <!-- Board Initialization Script -->
    <script>
    // Initialize board ID from Flask template
    {% if board %}
    window.boardId = "{{ board.id }}";
    {% else %}
    window.boardId = null;
    {% endif %}
    </script>

    <!-- Application JavaScript Modules -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/interactive-mode.js"></script>
    <script src="/static/js/board-management.js"></script>
    <script src="/static/js/thought-management.js"></script>

    <!-- Export C.P.F. Handler -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var cpfMenuLink = document.getElementById('export-cpf-link');
        if (cpfMenuLink) {
            cpfMenuLink.addEventListener('click', function (e) {
                e.preventDefault();
                fetch('/prompts/prompts_modified.txt', {method: 'GET'})
                    .then(response => {
                        if (response.ok) {
                            response.blob().then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = 'prompts_modified.txt';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(url);
                            });
                        } else {
                            alert('C.P.F. file not found on server.');
                        }
                    })
                    .catch(() => {
                        alert('C.P.F. file not found on server.');
                    });
            });
        }
    });
    </script>
</body>
</html>
