<!DOCTYPE html>
<!-- [DEBUG] index.html file loaded! -->
<html lang="en">

<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/fix_removeAISuggestion.js"></script>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAPSWORK</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/templates/interactive_gaps_custom.css">
    <style>
        .thought-list.drop-highlight {
            background: #e0f7fa;
            border: 2px dashed #007bff;
        }

        .disabled-link {
            pointer-events: none;
            opacity: 0.5;
        }

        #trash-can {
            right: -160px !important;
            /* move even further right */
            top: 65%;
            /* move slightly lower */
            z-index: 1 !important;
            /* lowest possible */
        }

        #board-menu-dropdown {
            position: absolute !important;
            z-index: 2000 !important;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f7f9fb;
            margin: 0;
            padding: 0;
        }

        header {
            background: #007bff;
            color: #fff;
            padding: 1rem 2rem;
            text-align: center;
        }

        main {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 1rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.07);
        }

        .quadrants {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .quadrant {
            background: #f1f5fa;
            border-radius: 10px;
            padding: 1rem;
            min-height: 180px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .quadrant h2 {
            margin-top: 0;
            font-size: 1.1rem;
            color: #007bff;
        }

        .thought-item {
            background: #fff;
            border-radius: 6px;
            margin: 0.5rem 0;
            padding: 0.5rem 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .thought-controls button,
        .thought-controls select {
            background: none;
            border: none;
            color: #888;
            margin-left: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
        }

        .thought-controls button:hover,
        .thought-controls select:hover {
            color: #007bff;
        }

        .add-thought {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .add-thought input,
        .add-thought select {
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        .add-thought button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .add-thought button:disabled {
            background: #b0d1ff;
            cursor: not-allowed;
        }

        .add-thought .voice-btn {
            background: none;
            border: none;
            color: #007bff;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .add-thought .voice-btn.listening {
            color: #e74c3c;
        }

        .notification {
            display: none;
            position: fixed;
            top: 1.5rem;
            right: 2rem;
            background: #007bff;
            color: #fff;
            padding: 0.8rem 1.2rem;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            z-index: 1000;
            font-size: 1.05rem;
        }

        .ai-panel {
            background: #f8fafc;
            padding: 1.2rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            margin-bottom: 2rem;
        }

        .ai-panel label {
            font-weight: 600;
            margin-right: 1rem;
        }

        .ai-panel select,
        .ai-panel textarea {
            margin-bottom: 0.5rem;
        }

        .ai-panel .ai-output {
            background: #fff;
            border-radius: 7px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #e0e6ee;
            min-height: 60px;
            font-size: 1.06rem;
        }

        .ai-panel .ai-actions {
            margin-top: 0.5rem;
        }

        #gaps-kb-content h1,
        #gaps-kb-content h2,
        #gaps-kb-content h3 {
            font-weight: bold;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }

        #gaps-kb-content h1 {
            font-size: 1.7em;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0.2em;
        }

        #gaps-kb-content h2 {
            font-size: 1.3em;
            color: #007bff;
        }

        #gaps-kb-content h3 {
            font-size: 1.15em;
            color: #0056b3;
        }

        #gaps-kb-content ul,
        #gaps-kb-content ol {
            margin-left: 1.3em;
            margin-bottom: 1em;
        }

        #gaps-kb-content li {
            margin-bottom: 0.3em;
        }

        #gaps-kb-content pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 0.8em 1em;
            overflow-x: auto;
            margin: 1em 0;
        }

        #gaps-kb-content code {
            font-family: "Fira Mono", "Consolas", "Menlo", monospace;
            background: #f6f8fa;
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-size: 0.98em;
        }

        #gaps-kb-content blockquote {
            border-left: 4px solid #d0d7de;
            background: #f7f7fa;
            color: #555;
            margin: 1em 0;
            padding: 0.6em 1em;
        }

        #gaps-kb-content p {
            margin: 0.7em 0;
        }

        #gaps-kb-content pre,
        #gaps-kb-content code,
        #gaps-kb-content pre code {
            background: #f6f8fa !important;
            border-radius: 6px;
            padding: 0.8em 1em;
            overflow-x: auto;
            margin: 1em 0;
            font-family: "Fira Mono", "Consolas", "Menlo", monospace;
            font-size: 0.98em;
            color: #222;
        }

        #gaps-kb-content code {
            padding: 0.1em 0.3em;
            border-radius: 3px;
            background: #f6f8fa !important;
        }

        #help-overlay {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.35);
            z-index: 3000;
        }

        .help-circle {
            position: fixed;
            width: 38px;
            height: 38px;
            background: #fffbe0;
            border: 2.5px solid #ffe066;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            color: #007bff;
            font-size: 1.3em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 3100;
            transition: background 0.2s, border 0.2s;
        }

        .help-circle:hover {
            background: #ffe066;
            color: #222;
        }

        #help-tooltip {
            position: fixed;
            background: #fff;
            border: 1.5px solid #007bff;
            border-radius: 8px;
            padding: 1em 1.3em;
            font-size: 1.08em;
            color: #222;
            box-shadow: 0 2px 14px rgba(0, 0, 0, 0.09);
            max-width: 360px;
            z-index: 3200;
            display: none;
        }

        @media (max-width: 800px) {
            main {
                padding: 0.5rem;
            }

            .quadrants {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
<script>
// Helper to extract list items from a quadrant
function getQuadrantListById(listId) {
    const list = document.getElementById(listId);
    if (!list) return [];
    return Array.from(list.querySelectorAll('li')).map(li => li.textContent.trim());
}
// Helper to get CSRF token from meta tag (adjust if stored elsewhere)
function getCsrfToken() {
    const meta = document.querySelector('meta[name=csrf-token]');
    return meta ? meta.getAttribute('content') : '';
}
// Set boardId from Flask/Jinja context (adjust variable as needed)
window.boardId = typeof window.boardId !== 'undefined' ? window.boardId : (typeof board_id !== 'undefined' ? board_id : null);
</script>

    <!-- Board Creation Modal -->
    <div id="create-board-modal"
        style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
        <div
            style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:340px;width:90%;margin:auto;display:flex;flex-direction:column;gap:1em;">
            <h3 style="margin:0 0 0.5em 0;">Create New Board</h3>
            <label for="modal-board-name" style="font-weight:500;">Board Name:</label>
            <input id="modal-board-name" type="text"
                style="padding:0.6em;font-size:1em;border-radius:6px;border:1px solid #ccc;"
                placeholder="Enter board name" autofocus />
            <div style="display:flex;gap:1em;justify-content:flex-end;margin-top:0.5em;">
                <button id="modal-create-board-btn"
                    style="background:#007bff;color:#fff;padding:0.6em 1.2em;border:none;border-radius:5px;font-size:1em;cursor:pointer;">Create</button>
                <button id="modal-cancel-board-btn"
                    style="background:#eee;color:#444;padding:0.6em 1.2em;border:none;border-radius:5px;font-size:1em;cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="board-menu-container" style="position: absolute; top: 16px; right: 24px; z-index: 10;">
        <span id="board-menu-icon" style="font-size: 1.8em; cursor: pointer; user-select: none;" title="Board options">
            <i class="fa fa-info-circle"></i>
        </span>
        <div id="board-menu-dropdown"
            style="display: none; position: absolute; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 160px; padding: 8px 0;">
            <a href="#" id="open-board"
                style="display: block; padding: 8px 20px; color: #333; text-decoration: none;">Open Board</a>
            <a href="#" id="create-board"
                style="display: block; padding: 8px 20px; color: #333; text-decoration: none;">Create New Board</a>
            <a href="#" id="export-data"
                style="display: block; padding: 8px 20px; color: #333; text-decoration: none;">Export Data</a>
            <a href="#" id="import-data"
                style="display: block; padding: 8px 20px; color: #333; text-decoration: none;">Import Data</a>
            <a href="#" id="delete-board"
                style="display: block; padding: 8px 20px; color: #c00; text-decoration: none;">Delete Board</a>
            <a href="#" id="help-link" onclick="showHelpOverlay(); return false;"
                style="display: block; padding: 8px 20px; color: #007bff; text-decoration: none;">Help</a>
            <a href="#" id="interactive-gaps-link"
                style="display: block; padding: 8px 20px; color: #333; text-decoration: none;">Interactive mode</a>
            <div class="dropdown-divider" style="border-top:1px solid #e5e5e5; margin:4px 0;"></div>
            <a href="#" id="reset-conversation-link"
                style="display: block; padding: 8px 20px; color: #d9534f; text-decoration: none;">Reset Conversation</a>
            <a href="#" id="summarize-conversation-link"
                style="display: block; padding: 8px 20px; color: #f0ad4e; text-decoration: none;">Summarize
                Conversation</a>
            <a href="#" id="export-conversation-link"
                style="display: block; padding: 8px 20px; color: #5bc0de; text-decoration: none;">Export Conversation
                Log</a>
            <a href="#" id="export-cpf-link"
                style="display: block; padding: 8px 20px; color: #6c3cff; text-decoration: none;">Export C.P.F.</a>
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('logout') }}" id="logout-link"
                style="display: block; padding: 8px 20px; color: #333; text-decoration: none;">Logout</a>
            {% endif %}
            {# Version number below logout #}
            {% if version %}
            <div style="text-align:center; color:#aaa; font-size:0.95em; margin-top:6px; margin-bottom:2px;">
                v{{ version }}
            </div>
            {% endif %}
        </div>
    </div>
    <header>
        <h1>GAPSWORK</h1>
        <button id="learn-more-gaps-btn"
            style="margin-left:2em;padding:0.5em 1em;font-size:1em;background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer;">Learn
            More about GAPS</button>
        <div id="gaps-kb-modal"
            style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:3000;align-items:center;justify-content:center;">
            <div
                style="background:#fff;max-width:600px;width:90%;margin:auto;padding:2em 2em 1.5em 2em;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;">
                <button id="close-kb-modal"
                    style="position:absolute;top:1em;right:1em;background:none;border:none;font-size:1.4em;color:#007bff;cursor:pointer;">&times;</button>
                <div id="gaps-kb-content"
                    style="max-height:60vh;overflow-y:auto;font-size:1.08em;min-width:320px;color:#222;"></div>
            </div>
        </div>
    </header>
    <main>

        {% if board %}
        <div id="board-title"
            style="font-size:1.4em;font-weight:bold;margin:0 0 1.2em 0;text-align:center;letter-spacing:0.5px;">
            {{ board.name if board.name is defined and board.name else (board.title if board.title is defined and
            board.title else 'Untitled Board') }}
        </div>
        <script>console.log('[DEBUG] index.html script block loaded at LINE 374');
            window.boardId = "{{ board.id }}";
            // Show/hide conversation admin buttons if board is selected
            window.addEventListener('DOMContentLoaded', function () {
                var resetLink = document.getElementById('reset-conversation-link');
                var summarizeLink = document.getElementById('summarize-conversation-link');
                var exportLink = document.getElementById('export-conversation-link');
                if (window.boardId) {
                    // No need to show/hide dropdown links; they're always visible in the dropdown
                    // Reset
                    if (resetLink) {
                        resetLink.onclick = async function (e) {
                            e.preventDefault();
                            if (!confirm('Reset conversation for this board? This cannot be undone.')) return;
                            const origText = resetLink.textContent;
                            resetLink.classList.add('disabled-link');
                            resetLink.textContent = 'Resetting...';
                            try {
                                const resp = await fetch('/reset_conversation', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                    },
                                    body: JSON.stringify({ board_id: window.boardId })
                                });
                                const data = await resp.json();
                                if (data.success) {
                                    showNotification('Conversation reset!', false);
                                    setTimeout(() => location.reload(), 1500);
                                } else {
                                    showNotification('Reset failed: ' + (data.error || 'Unknown error'), true);
                                }
                            } catch (err) {
                                showNotification('Reset failed: ' + err.message, true);
                            }
                            resetLink.classList.remove('disabled-link');
                            resetLink.textContent = origText;
                        };
                    }
                    // Summarize
                    if (summarizeLink) {
                        summarizeLink.onclick = async function (e) {
                            e.preventDefault();
                            const origText = summarizeLink.textContent;
                            summarizeLink.classList.add('disabled-link');
                            summarizeLink.textContent = 'Summarizing...';
                            try {
                                const resp = await fetch('/summarize_conversation', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                    },
                                    body: JSON.stringify({ board_id: window.boardId })
                                });
                                const data = await resp.json();
                                if (data.success) {
                                    showNotification('Conversation summarized!<br><b>Summary:</b><br>' + data.summary, false, true); // true = persistent
                                    // No auto-reload for summary
                                } else {
                                    showNotification('Summarize failed: ' + (data.error || 'Unknown error'), true);
                                }
                            } catch (err) {
                                showNotification('Summarize failed: ' + err.message, true);
                            }
                            summarizeLink.classList.remove('disabled-link');
                            summarizeLink.textContent = origText;
                        };
                    }
                    // Export
                    if (exportLink) {
                        exportLink.onclick = async function (e) {
                            e.preventDefault();
                            const origText = exportLink.textContent;
                            exportLink.classList.add('disabled-link');
                            exportLink.textContent = 'Exporting...';
                            try {
                                const resp = await fetch('/export_conversation', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                    },
                                    body: JSON.stringify({ board_id: window.boardId })
                                });
                                if (resp.ok) {
                                    const blob = await resp.blob();
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = 'conversation_log_board_' + window.boardId + '.json';
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                    window.URL.revokeObjectURL(url);
                                    showNotification('Conversation log exported!', false);
                                } else {
                                    showNotification('Export failed: ' + resp.statusText, true);
                                }
                            } catch (err) {
                                showNotification('Export failed: ' + err.message, true);
                            }
                            exportLink.classList.remove('disabled-link');
                            exportLink.textContent = origText;
                        };
                    }
                }
            });

            // --- GLOBAL drag-and-drop handlers for trash can ---
            window.handleTrashDrop = function (event) {
                event.preventDefault();
                const trashCan = document.getElementById('trash-can');
                const trashIcon = document.getElementById('trash-icon');
                trashCan.style.background = '#f8f8f8';
                trashCan.style.borderColor = '#eee';
                trashIcon.style.color = '#c00';
                const thoughtId = event.dataTransfer.getData('text/plain');
                console.log('[TRASH CAN] handleTrashDrop fired, thoughtId:', thoughtId);
                if (thoughtId) {
                    confirmDeleteThought(thoughtId);
                }
            };
            window.clearTrashHighlight = function () {
                const trashCan = document.getElementById('trash-can');
                const trashIcon = document.getElementById('trash-icon');
                if (trashCan && trashIcon) {
                    trashCan.style.background = '#f8f8f8';
                    trashCan.style.borderColor = '#eee';
                    trashIcon.style.color = '#c00';
                }
            };
        </script>
        {% endif %}
        <div class="quadrants"
            style="position: relative; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
            <!-- Trash Can Drop Target -->
            <div id="trash-can" ondragover="event.preventDefault()" ondrop="handleTrashDrop(event)"
                style="position: absolute; right: -80px; top: 50%; transform: translateY(-50%); width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f8f8f8; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #eee; transition: background 0.2s, border 0.2s; z-index: 9999; pointer-events: all;">
                <i class="fa fa-trash" id="trash-icon" style="font-size: 2.2em; color: #c00;"></i>
            </div>
            <div class="quadrant" id="status-quadrant" ondragover="event.preventDefault()"
                ondrop="dropThought(event, 'status')">
                <h2>Status</h2>
                <ul id="status-list" class="thought-list" draggable="false" ondragover="highlightDrop(event, this)"
                    ondragleave="unhighlightDrop(this)" ondragenter="highlightDrop(event, this)"
                    ondrop="dropThought(event, 'status')" style="min-height:40px;">
                    {% set plist = thoughts['status'] if 'status' in thoughts else [] %}
                    {% if plist|length == 0 %}
                    <li style="color:#aaa;font-style:italic;">No thoughts yet.</li>
                    {% else %}
                    {% for t in plist %}
                    <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ t.id }}')"
                        ondragend="clearTrashHighlight()" data-id="{{ t.id }}">
                        <span class="thought-content" onclick="editThought(this, {{ t.id }})">{{ t.content }}</span>
                        <span class="thought-controls">
                            <select onchange="thoughtActionDropdown(this, {{ t.id }})" data-current="{{ t.quadrant }}">
                                <option value="status" {% if t.quadrant=='status' %}selected{% endif %}>Status</option>
                                <option value="goal" {% if t.quadrant=='goal' %}selected{% endif %}>Goal</option>
                                <option value="analysis" {% if t.quadrant=='analysis' %}selected{% endif %}>Analysis
                                </option>
                                <option value="plan" {% if t.quadrant=='plan' %}selected{% endif %}>Plan</option>
                                <option value="delete">Delete</option>
                            </select>
                        </span>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="quadrant" id="goal-quadrant" ondragover="event.preventDefault()"
                ondrop="dropThought(event, 'goal')">
                <h2>Goal</h2>
                <ul id="goal-list" class="thought-list" draggable="false" ondragover="highlightDrop(event, this)"
                    ondragleave="unhighlightDrop(this)" ondragenter="highlightDrop(event, this)"
                    ondrop="dropThought(event, 'goal')" style="min-height:40px;">
                    {% set slist = thoughts['goal'] if 'goal' in thoughts else [] %}
                    {% if slist|length == 0 %}
                    <li style="color:#aaa;font-style:italic;">No thoughts yet.</li>
                    {% else %}
                    {% for t in slist %}
                    <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ t.id }}')"
                        ondragend="clearTrashHighlight()" data-id="{{ t.id }}">
                        <span class="thought-content" onclick="editThought(this, {{ t.id }})">{{ t.content }}</span>
                        <span class="thought-controls">
                            <select onchange="thoughtActionDropdown(this, {{ t.id }})" data-current="{{ t.quadrant }}">
                                <option value="status" {% if t.quadrant=='status' %}selected{% endif %}>Status</option>
                                <option value="goal" {% if t.quadrant=='goal' %}selected{% endif %}>Goal</option>
                                <option value="analysis" {% if t.quadrant=='analysis' %}selected{% endif %}>Analysis
                                </option>
                                <option value="plan" {% if t.quadrant=='plan' %}selected{% endif %}>Plan</option>
                                <option value="delete">Delete</option>
                            </select>
                        </span>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="quadrant" id="analysis-quadrant" ondragover="event.preventDefault()"
                ondrop="dropThought(event, 'analysis')">
                <h2>Analysis</h2>
                <ul id="analysis-list" class="thought-list" draggable="false" ondragover="highlightDrop(event, this)"
                    ondragleave="unhighlightDrop(this)" ondragenter="highlightDrop(event, this)"
                    ondrop="dropThought(event, 'analysis')" style="min-height:40px;">
                    {% set solist = thoughts['analysis'] if 'analysis' in thoughts else [] %}
                    {% if solist|length == 0 %}
                    <li style="color:#aaa;font-style:italic;">No thoughts yet.</li>
                    {% else %}
                    {% for t in solist %}
                    <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ t.id }}')"
                        ondragend="clearTrashHighlight()" data-id="{{ t.id }}">
                        <span class="thought-content" onclick="editThought(this, {{ t.id }})">{{ t.content }}</span>
                        <span class="thought-controls">
                            <select onchange="thoughtActionDropdown(this, {{ t.id }})" data-current="{{ t.quadrant }}">
                                <option value="status" {% if t.quadrant=='status' %}selected{% endif %}>Status</option>
                                <option value="goal" {% if t.quadrant=='goal' %}selected{% endif %}>Goal</option>
                                <option value="analysis" {% if t.quadrant=='analysis' %}selected{% endif %}>Analysis
                                </option>
                                <option value="plan" {% if t.quadrant=='plan' %}selected{% endif %}>Plan</option>
                                <option value="delete">Delete</option>
                            </select>
                        </span>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="quadrant" id="plan-quadrant" ondragover="event.preventDefault()"
                ondrop="console.log('ondrop quadrant plan'); dropThought(event, 'plan')">
                <h2>Plan</h2>
                <ul id="plan-list" class="thought-list" draggable="false" ondragover="highlightDrop(event, this)"
                    ondragleave="unhighlightDrop(this)" ondragenter="console.log('dragenter plan');"
                    ondrop="console.log('ondrop HTML fired plan'); dropThought(event, 'plan')" style="min-height:40px;">
                    {% set plist = thoughts['plan'] if 'plan' in thoughts else [] %}
                    {% if plist|length == 0 %}
                    <li style="color:#aaa;font-style:italic;">No thoughts yet.</li>
                    {% else %}
                    {% for t in plist %}
                    <li class="thought-item" draggable="true" ondragstart="dragThought(event, '{{ t.id }}')"
                        ondragend="clearTrashHighlight()" data-id="{{ t.id }}">
                        <span class="thought-content" onclick="editThought(this, {{ t.id }})">{{ t.content }}</span>
                        <span class="thought-controls">
                            <select onchange="thoughtActionDropdown(this, {{ t.id }})" data-current="{{ t.quadrant }}">
                                <option value="status" {% if t.quadrant=='status' %}selected{% endif %}>Status</option>
                                <option value="goal" {% if t.quadrant=='goal' %}selected{% endif %}>Goal</option>
                                <option value="analysis" {% if t.quadrant=='analysis' %}selected{% endif %}>Analysis
                                </option>
                                <option value="plan" {% if t.quadrant=='plan' %}selected{% endif %}>Plan</option>
                                <option value="delete">Delete</option>
                            </select>
                        </span>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
        </div>
        <div class="add-thought">
            <textarea id="new-thought-input"
                placeholder="Tell me what's going on, what problems you're facing, or concerns you'd like my help with"
                rows="3"
                style="flex:2;padding:0.7em 1em;border-radius:5px;border:1px solid #ccc;font-size:1em;resize:vertical;min-height:44px;max-height:160px;"></textarea>
            <select id="new-thought-quadrant">
                <option value="auto" selected>Let AI Decide</option>
                <option value="status">Status</option>
                <option value="goal">Goal</option>
                <option value="analysis">Analysis</option>
                <option value="plan">Plan</option>
            </select>
            <button id="add-thought-btn">Add</button>
            <button id="voice-btn" class="voice-btn" title="Voice input"><i id="voice-icon"
                    class="fa fa-microphone"></i></button>
            <span id="voice-status" style="display:none;margin-left:0.5rem;color:#e74c3c;">Listening...</span>
        </div>
        <div id="notification" class="notification"></div>
        <!-- Interactive GAPS Modal -->
        <div id="interactive-gaps-modal"
            style="display:none;position:fixed;z-index:3000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
            <div id="interactive-gaps-modal-content"
                style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:500px;width:95%;margin:auto;display:flex;flex-direction:column;gap:1em;">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:1em;">
                    <h3 style="margin:0 0 0.5em 0;">Interactive GAPS Facilitator</h3>
                    <button id="interactive-gaps-minimize" title="Minimize"
                        style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#888;line-height:1;">&#8211;</button>
                </div>
                <div id="interactive-gaps-chat"
                    style="height:220px;overflow-y:auto;background:#f8fafc;border-radius:8px;padding:1em;margin-bottom:1em;font-size:1.05em;">
                </div>
                <div style="display:flex;gap:0.5em;align-items:center;">
                    <textarea id="interactive-gaps-input" placeholder="Type your response..." rows="4"
                        style="flex:1;padding:0.7em 1em;border-radius:5px;border:1px solid #ccc;font-size:1em;resize:vertical;min-height:48px;max-height:180px;"></textarea>
                    <button id="interactive-gaps-send"
                        style="background:#007bff;color:#fff;padding:0.7em 1.4em;border:none;border-radius:5px;font-size:1em;cursor:pointer;">Send</button>
                    <button id="interactive-gaps-close"
                        style="background:#eee;color:#444;padding:0.7em 1.2em;border:none;border-radius:5px;font-size:1em;cursor:pointer;">Close</button>
                </div>
            </div>

        </div>
        </div>

        <!-- Help overlay (hidden by default) -->
        <div id="help-overlay" style="display:none;">
            <div id="help-circles-container"></div>
            <div id="help-tooltip" style="display:none;"></div>
            <button onclick="hideHelpOverlay()" id="help-close-btn"
                style="position:fixed;top:30px;right:30px;z-index:1101;">Close Help</button>
        </div>

    </main>
    <script>
        console.log('[DEBUG] index.html script block loaded at LINE 678');
        document.addEventListener('DOMContentLoaded', function () {
            var learnBtn = document.getElementById('learn-more-gaps-btn');
            var modal = document.getElementById('gaps-kb-modal');
            var closeBtn = document.getElementById('close-kb-modal');
            var contentDiv = document.getElementById('gaps-kb-content');

            if (learnBtn && modal && closeBtn && contentDiv) {
                learnBtn.onclick = async function () {
                    modal.style.display = 'flex';
                    contentDiv.innerHTML = '<em>Loading...</em>';
                    try {
                        const resp = await fetch('/gaps_kb');
                        const data = await resp.json();
                        if (data.content) {
                            // Render markdown as HTML using marked.js
                            contentDiv.innerHTML = marked.parse(data.content);
                            // Force repaint/reflow to fix display bug
                            contentDiv.scrollTop = 0;
                            contentDiv.style.display = 'none';
                            contentDiv.offsetHeight; // force reflow
                            contentDiv.style.display = '';
                        } else {
                            contentDiv.innerHTML = '<span style="color:red">Failed to load knowledge base.</span>';
                        }
                    } catch (e) {
                        contentDiv.innerHTML = '<span style="color:red">Error: ' + e.message + '</span>';
                    }
                };
                closeBtn.onclick = function () {
                    modal.style.display = 'none';
                };
                modal.onclick = function (e) {
                    if (e.target === modal) modal.style.display = 'none';
                };
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const interactiveGapsModal = document.getElementById('interactive-gaps-modal');
            const interactiveGapsLink = document.getElementById('interactive-gaps-link');
            const interactiveGapsClose = document.getElementById('interactive-gaps-close');
            const interactiveGapsSend = document.getElementById('interactive-gaps-send');
            const interactiveGapsInput = document.getElementById('interactive-gaps-input');
            const interactiveGapsChat = document.getElementById('interactive-gaps-chat');

            if (interactiveGapsLink) {
                console.log('[DEBUG] interactiveGapsLink found at DOMContentLoaded');
                interactiveGapsLink.addEventListener('click', function(e) {
                    console.log('[DEBUG] Interactive mode link clicked');
                    e.preventDefault();
                    if (!interactiveGapsModal) {
                        console.log('[DEBUG] interactiveGapsModal is null!');
                    } else {
                        interactiveGapsModal.style.display = 'flex';
                        console.log('[DEBUG] Modal display set to flex');
                    }
                    // Gather current quadrants
                    const quadrants = {
                        status: getQuadrantListById('status-list'),
                        goal: getQuadrantListById('goal-list'),
                        analysis: getQuadrantListById('analysis-list'),
                        plan: getQuadrantListById('plan-list'),
                    };
                    console.log('[DEBUG] Quadrants on modal open:', quadrants);
                    const allEmpty = Object.values(quadrants).every(arr => arr.length === 0);
                    // Remove hardcoded onboarding/prior work message. Let the AI handle onboarding from the prompt.
                    // Always trigger AI fetch regardless of quadrant state
                    let user_input, postData;
                    if (allEmpty) {
                        // Empty board: onboarding
                        user_input = 'The GAPS quadrants are currently empty. Please help me get started by first asking what problem, challenge, or topic I want to work on, and then guide me step by step through the GAPS process.';
                        postData = {
                            board_id: window.boardId,
                            user_input: user_input
                        };
                    } else {
                        // Non-empty board: kickoff prompt for quadrant-aware summary
                        user_input = '';
                        postData = {
                            board_id: window.boardId,
                            user_input: user_input,
                            quadrants: quadrants
                        };
                    }
                    interactiveGapsChat.innerHTML = "<div style='color:#888; margin-bottom:0.7em;display:flex;align-items:center;gap:0.7em;'><span class='spinner' style='display:inline-block;width:18px;height:18px;border:2px solid #bbb;border-top:2px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;'></span> Waiting for AI response...</div>";
                    fetch('/interactive_gaps', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                        },
                        body: JSON.stringify(postData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('[DEBUG] before backend result log');
                        console.log('[DEBUG] Backend result:', data);
                        console.log('[DEBUG] after backend result log');
                        // --- SUGGESTION UI PATCH: Render AI suggestions as Add buttons ---
                        if (data.suggestions && Array.isArray(data.suggestions.add_to_quadrant)) {
                            let sugHtml = '<div class="ai-suggest-label" style="margin:0.7em 0 0.2em 0;font-weight:bold;color:#007bff;">AI suggests adding the following:</div>';
                            data.suggestions.add_to_quadrant.forEach(function(item, idx) {
                                if (item.quadrant && item.thought) {
                                    const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                                    sugHtml += `<div style='margin-bottom:0.3em;padding:0.3em 0.5em;background:#f5faff;border-radius:6px;'>\n <span style='color:#007bff;font-weight:bold;'>${item.quadrant.charAt(0).toUpperCase() + item.quadrant.slice(1)}:</span>\n <span class='ai-suggested-thought'>${item.thought}</span>\n <button id='${btnId}' style='margin-left:0.7em;font-size:0.95em;padding:0.2em 0.7em;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;'>Add to Quadrant</button>\n </div>`;
                                    setTimeout(() => {
                                        const btn = document.getElementById(btnId);
                                        if (btn) {
                                            btn.addEventListener('click', async function() {
                                                const boardId = window.boardId || null;
                                                if (!boardId) {
                                                    alert('No board selected.');
                                                    return;
                                                }
                                                try {
                                                    const resp = await fetch('/add_thought', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                            'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                                        },
                                                        body: JSON.stringify({
                                                            content: item.thought,
                                                            quadrant: item.quadrant,
                                                            board_id: boardId
                                                        })
                                                    });
                                                    const result = await resp.json();
                                                    if (result.success) {
                                                        if (typeof window.refreshQuadrants === 'function') {
                                                            window.refreshQuadrants();
                                                        }
                                                        btn.disabled = true;
                                                        btn.textContent = 'Added!';
                                                        btn.style.background = '#5cb85c';
                                                        btn.style.color = '#fff';
                                                        if (typeof showNotification === 'function') {
                                                            showNotification('Thought added to ' + item.quadrant + '!', false);
                                                        }
                                                    } else {
                                                        alert('Failed to save thought: ' + (result.error || 'Unknown error'));
                                                    }
                                                } catch (err) {
                                                    alert('Error saving thought: ' + err.message);
                                                }
                                            });
                                        }
                                    }, 0);
                                }
                            });
                            // Insert below the chat window
                            let sugBox = document.getElementById('ai-suggestion-box');
                            if (!sugBox) {
                                sugBox = document.createElement('div');
                                sugBox.id = 'ai-suggestion-box';
                                interactiveGapsChat.parentNode.insertBefore(sugBox, interactiveGapsChat.nextSibling);
                            }
                            // Clean up stray newlines and excess whitespace
sugHtml = sugHtml.replace(/\n/g, '').replace(/\s{2,}/g, ' ');
sugBox.innerHTML = sugHtml;
                            sugBox.style.display = 'block';
                        }
                        if (data && data.reply) {
                            // Always show the AI's conversational reply in the chat window
                            interactiveGapsChat.innerHTML += `<div style='margin-top:0.7em;color:#007bff;'><b>AI:</b> ${data.reply.replace(/\n/g, '<br>')}</div>`;
                            interactiveGapsChat.scrollTop = interactiveGapsChat.scrollHeight;
                        }
                    })
                    .catch(err => {
                        interactiveGapsChat.innerHTML = "<div style='color:#c00;'>Error contacting AI. Please try again.</div>";
                    });
                    interactiveGapsInput.value = '';
                    interactiveGapsInput.focus();
                });
            } else {
                console.log('[DEBUG] interactiveGapsLink not found at DOMContentLoaded');
            }
        });
        // Removed old/duplicate Interactive Mode modal JS blocks between lines 800–1300. Only the new consolidated Interactive Mode modal logic remains.

        // --- Draggable modal header ---
        if (interactiveGapsModal) {
            const header = interactiveGapsModal.querySelector('h3').parentElement;
            let isDragging = false, offsetX = 0, offsetY = 0;
            if (header) {
                header.style.cursor = 'move';
                header.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    const rect = interactiveGapsModal.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    document.body.style.userSelect = 'none';
                });
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    interactiveGapsModal.style.left = (e.clientX - offsetX) + 'px';
                    interactiveGapsModal.style.top = (e.clientY - offsetY) + 'px';
                    interactiveGapsModal.style.right = '';
                    interactiveGapsModal.style.bottom = '';
                    interactiveGapsModal.style.position = 'fixed';
                    interactiveGapsModal.style.justifyContent = '';
                });
                document.addEventListener('mouseup', function() {
                    isDragging = false;
                    document.body.style.userSelect = '';
                });
            }
        } catch (e) {
        // continue looking
        }
        }
        }
        return null;
        }
        let jsonExtract = extractFirstJsonObject(aiMsg);
        if (jsonExtract) {
        parsed = jsonExtract.obj;
        preText = aiMsg.slice(0, jsonExtract.start).trim();
        postText = aiMsg.slice(jsonExtract.end).trim();
        } else {
        // fallback to full parse if reply is pure JSON
        try {
        parsed = JSON.parse(aiMsg);
        } catch (err) {
        parsed = null;
        }
        }
        if (preText) {
        rendered += `<div style='margin-bottom:0.5em;color:#444;'>${preText.replace(/\n/g,'<br>')}</div>`;
        }
        if (parsed && typeof parsed === 'object') {
        // If it's a structured object, render nicely
        if (parsed.add_to_quadrant && Array.isArray(parsed.add_to_quadrant)) {
        rendered += `<div class='ai-suggest-label'>AI suggests adding the following:</div>`;
        parsed.add_to_quadrant.forEach(function(item, idx) {
        if (item.quadrant && item.thought) {
        const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
        rendered += `<div style='margin-bottom:0.3em;padding:0.3em 0.5em;background:#f5faff;border-radius:6px;'>
            <span style='color:#007bff;font-weight:bold;'>${item.quadrant.charAt(0).toUpperCase() +
                item.quadrant.slice(1)}:</span>
            <span class='ai-suggested-thought'>${item.thought}</span>
            <button id='${btnId}'
                style='margin-left:0.7em;font-size:0.95em;padding:0.2em 0.7em;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;'>Add
                to Quadrant</button>
        </div>`;
        setTimeout(() => {
        const btn = document.getElementById(btnId);
        if (btn) {
        btn.addEventListener('click', async function() {
        const boardId = window.boardId || null;
        if (!boardId) {
        alert('No board selected.');
        return;
        }
        // Save to backend
        try {
        const resp = await fetch('/add_thought', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
        },
        body: JSON.stringify({
        content: item.thought,
        quadrant: item.quadrant,
        board_id: boardId
        })
        });
        const result = await resp.json();
        if (result.success) {
        // Instead of manual DOM update, refresh all quadrants for consistency
        if (typeof window.refreshQuadrants === 'function') {
        window.refreshQuadrants();
        }
        btn.disabled = true;
        btn.textContent = 'Added!';
        btn.style.background = '#5cb85c';
        btn.style.color = '#fff';
        if (typeof showNotification === 'function') {
        showNotification('Thought added to ' + item.quadrant + '!', false);
        }
        } else {
        alert('Failed to save thought: ' + (result.error || 'Unknown error'));
        }
        } catch (err) {
        alert('Error saving thought: ' + err.message);
        }
        // DO NOT clear interactiveGapsChat or trigger onboarding here!
        });
        }
        }, 0);
        }
        });
        } else if (parsed.question) {
        rendered = `<span style='color:#444;'>${parsed.question.replace(/\n/g,'<br>')}</span>`;
        } else if (parsed.message) {
        rendered = `<span style='color:#444;'>${parsed.message.replace(/\n/g,'<br>')}</span>`;
        } else {
        rendered = `<span style='color:#444;'>${JSON.stringify(parsed)}</span>`;
        }
        } else {
        // Fallback: plain text
        rendered = `<span style='color:#444;'>${aiMsg.replace(/\n/g,'<br>')}</span>`;
        }
        // Always render postText if present
        if (typeof postText === 'string') {
        const trimmedPostText = postText.trim();
        if (trimmedPostText) {
        rendered += `<div style='margin-top:0.5em;color:#444;'>${trimmedPostText.replace(/\n/g,'<br>')}</div>`;
        }
        }
        interactiveGapsChat.innerHTML += `<div style='margin-top:0.7em;color:#007bff;'><b>AI:</b> ${rendered}</div>`;
        interactiveGapsHistory.push({ role: 'assistant', content: aiMsg });
        // --- DEBUG: Log suggestions for troubleshooting ---
        console.log('[DEBUG] Checking for suggestions:', result.suggestions);
        console.log('[DEBUG] add_to_quadrant:', result.suggestions && result.suggestions.add_to_quadrant);
        // --- NEW: Render suggestions from result.suggestions if present ---
        if (result.suggestions && Array.isArray(result.suggestions.add_to_quadrant)) {
        let sugHtml = `<div class='ai-suggest-label'>AI suggests adding the following:</div>`;
        result.suggestions.add_to_quadrant.forEach(function(item, idx) {
        if (item.quadrant && item.thought) {
        const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
        sugHtml += `<div style='margin-bottom:0.3em;padding:0.3em 0.5em;background:#f5faff;border-radius:6px;'>\n <span
                style='color:#007bff;font-weight:bold;'>${item.quadrant.charAt(0).toUpperCase() +
                item.quadrant.slice(1)}:</span> \n <span class='ai-suggested-thought'>${item.thought}</span>\n <button
                id='${btnId}'
                style='margin-left:0.7em;font-size:0.95em;padding:0.2em 0.7em;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;'>Add
                to Quadrant</button>\n </div>`;
        setTimeout(() => {
        const btn = document.getElementById(btnId);
        if (btn) {
        btn.addEventListener('click', async function() {
        const boardId = window.boardId || null;
        if (!boardId) {
        alert('No board selected.');
        return;
        }
        try {
        const resp = await fetch('/add_thought', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
        },
        body: JSON.stringify({
        content: item.thought,
        quadrant: item.quadrant,
        board_id: boardId
        })
        });
        const result = await resp.json();
        if (result.success) {
        if (typeof window.refreshQuadrants === 'function') {
        window.refreshQuadrants();
        }
        btn.disabled = true;
        btn.textContent = 'Added!';
        btn.style.background = '#5cb85c';
        btn.style.color = '#fff';
        if (typeof showNotification === 'function') {
        showNotification('Thought added to ' + item.quadrant + '!', false);
        }
        } else {
        alert('Failed to save thought: ' + (result.error || 'Unknown error'));
        }
        } catch (err) {
        alert('Error saving thought: ' + err.message);
        }
        });
        }
        }, 0);
        }
        });
        // Append suggestions to the chat window
        interactiveGapsChat.innerHTML += `<div id="ai-suggestion-box">${sugHtml}</div>`;
        }
        // --- DEBUG: (old debug suggestion box code commented out to avoid confusion) ---
        /*
        if (result.suggestions) {
        let suggestions = null;
        if (Array.isArray(result.suggestions)) {
        suggestions = result.suggestions;
        } else if (result.suggestions && Array.isArray(result.suggestions.add_to_quadrant)) {
        suggestions = result.suggestions.add_to_quadrant;
        }
        if (suggestions) {
        // Map 'thought' to 'content' if needed
        suggestions = suggestions.map(s => {
        if (typeof s === 'object' && s.thought && !s.content) {
        return { ...s, content: s.thought };
        }
        return s;
        });
        let sugBox = document.getElementById('ai-suggestion-box');
        if (!sugBox) {
        sugBox = document.createElement('div');
        sugBox.id = 'ai-suggestion-box';
        interactiveGapsChat.parentNode.insertBefore(sugBox, interactiveGapsChat.nextSibling);
        }
        sugBox.innerHTML = '<b>Suggestions:</b>
        <ul>' +
            suggestions.map(s => `<li>[${s.quadrant}] ${s.content}</li>`).join('') +
            '</ul>';
        sugBox.style.display = 'block';
        }
        }
        */
        } else if (result.error) {
        interactiveGapsChat.innerHTML += `<div style='margin-top:0.7em;color:#c00;'><b>AI:</b> <span
                style='color:#444;'>Error: ${result.error}</span></div>`;
        } else {
        interactiveGapsChat.innerHTML += `<div style='margin-top:0.7em;color:#c00;'><b>AI:</b> <span
                style='color:#444;'>No response from AI.</span></div>`;
        }
        interactiveGapsChat.scrollTop = interactiveGapsChat.scrollHeight;
        } catch (err) {
        interactiveGapsChat.innerHTML += `<div style='margin-top:0.7em;color:#c00;'><b>AI:</b> <span
                style='color:#444;'>Error: ${err.message}</span></div>`;
        interactiveGapsChat.scrollTop = interactiveGapsChat.scrollHeight;
        }
        });
        }
        interactiveGapsInput && interactiveGapsInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        interactiveGapsSend.click();
        }
        // Shift+Enter = newline (default behavior)
        });



        </script>

        <script>
            console.log('[DEBUG] index.html script block loaded at LINE 1199');
            window.addEventListener('unhandledrejection', function (event) {
                console.error('Unhandled promise rejection:', event.reason);
            });
            console.log('SCRIPT EXECUTED');

            // --- CSRF Token Helper ---
            function getCsrfToken() {
                const meta = document.querySelector('meta[name="csrf-token"]');
                return meta ? meta.getAttribute('content') : '';
            }

            // --- Main App Handler ---
            // Board menu and modal variables (moved to top scope to ensure global access)
            let menuIcon, dropdown, openBoardModal;
            document.addEventListener('DOMContentLoaded', function () {
                menuIcon = document.getElementById('board-menu-icon');
                dropdown = document.getElementById('board-menu-dropdown');
                openBoardModal = document.getElementById('open-board-modal');
                const boardList = document.getElementById('board-list');
                // Ensure addBtn is defined for all handlers
                const addBtn = document.getElementById('add-thought-btn');
                const newThoughtInput = document.getElementById('new-thought-input');
                const newThoughtQuadrant = document.getElementById('new-thought-quadrant');
                const closeBoardModal = document.getElementById('close-board-modal');

                // Conversational AI-driven add thought flow
                async function handleConversationalAddThought() {
                    let content = newThoughtInput.value.trim();
                    let boardId = window.boardId || null;
                    if (!content || !boardId) {
                        showNotification('Thought and board are required!', true);
                        return;
                    }
                    addBtn.disabled = true;
                    addBtn.textContent = 'Thinking...';
                    try {
                        const resp = await fetch('/ai_conversation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({ content, board_id: boardId })
                        });
                        const result = await resp.json();
                        if (result.success && result.thoughts) {
                            // AI classified and added thoughts
                            aiConversationActive = false;
                            newThoughtInput.value = '';
                            newThoughtInput.placeholder = aiPromptPlaceholder;
                            if (result.thoughts && Array.isArray(result.thoughts)) {
                                const onboardingOffer = "welcome! i use the gaps model to help clarify and solve problems. would you like a quick intro to how it works, or are you already familiar with gaps?";
                                result.thoughts = result.thoughts.filter(t => typeof t !== 'string' || t.trim().toLowerCase() !== onboardingOffer);
                            }
                            showNotification('Thought(s) added!');
                            // Wait for notification to finish before reloading page
                            if (window.notificationTimeout) clearTimeout(window.notificationTimeout);
                            window.notificationTimeout = setTimeout(() => {
                                location.reload();
                            }, 1800);
                        } else if (result.success && result.followup && (!result.thoughts || result.thoughts.length === 0)) {
                            // Only show followup if NO thoughts were added
                            aiConversationActive = true;
                            newThoughtInput.value = '';
                            newThoughtInput.placeholder = result.followup;
                            showNotification('AI: ' + result.followup);
                            addBtn.textContent = 'Respond';
                        } else if (result.error) {
                            showNotification('AI error: ' + result.error, true);
                            addBtn.textContent = 'Add';
                        } else if (result.success && result.reply) {
                            // Show AI reply in chat area below input
                            let chatDiv = document.getElementById('ai-conversation-chat');
                            if (!chatDiv) {
                                chatDiv = document.createElement('div');
                                chatDiv.id = 'ai-conversation-chat';
                                chatDiv.style.marginTop = '1em';
                                chatDiv.style.background = '#f8fafc';
                                chatDiv.style.borderRadius = '8px';
                                chatDiv.style.padding = '1em';
                                chatDiv.style.fontSize = '1.05em';
                                newThoughtInput.parentNode.parentNode.appendChild(chatDiv);
                            }
                            chatDiv.innerHTML += `<div style='margin-bottom:0.5em;color:#007bff;'><b>AI:</b> ${result.reply.replace(/\n/g, '<br>')}</div>`;
                            newThoughtInput.value = '';
                            newThoughtInput.placeholder = aiPromptPlaceholder;
                            addBtn.textContent = 'Add';
                        } else {
                            showNotification('Unexpected AI response.', true);
                            addBtn.textContent = 'Add';
                        }
                    } catch (e) {
                        showNotification('Error: ' + e.message, true);
                    } finally {
                        addBtn.disabled = false;
                    }
                }

                // Override Add Thought click handler for AI-driven flow if quadrant is 'auto'
                addBtn.addEventListener('click', async function () {
                    let quadrant = newThoughtQuadrant.value;
                    if (quadrant === 'auto') {
                        await handleConversationalAddThought();
                    } else {
                        // Fallback: classic add thought (manual quadrant)
                        let content = newThoughtInput.value.trim();
                        let boardId = window.boardId || null;
                        if (!content || !boardId) {
                            showNotification('Thought and board are required!', true);
                            return;
                        }
                        addBtn.disabled = true;
                        addBtn.textContent = 'Adding...';
                        try {
                            let addResp = await fetch('/add_thought', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify({
                                    content: content,
                                    quadrant: quadrant,
                                    board_id: boardId
                                })
                            });
                            let addResult = await addResp.json();
                            if (addResult.success) {
                                showNotification('Thought added!');
                                newThoughtInput.value = '';
                                setTimeout(() => location.reload(), 1200);
                            } else {
                                showNotification('Failed to add thought: ' + (addResult.error || 'Unknown error'), true);
                            }
                        } catch (e) {
                            showNotification('Error: ' + e.message, true);
                        } finally {
                            addBtn.disabled = false;
                            addBtn.textContent = 'Add';
                        }
                    }
                });

                // --- Board Menu Functionality ---
                if (dropdown) {
                    dropdown.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
                }
                menuIcon.addEventListener('click', function (e) {
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    e.stopPropagation();
                });
                document.addEventListener('click', function () {
                    if (dropdown) dropdown.style.display = 'none';
                });

                // Attach handlers for ALL dropdown menu items
                const openBoardLink = document.getElementById('open-board');
                const createBoardLink = document.getElementById('create-board');
                const exportDataLink = document.getElementById('export-data');
                const importDataLink = document.getElementById('import-data');
                const deleteBoardLink = document.getElementById('delete-board');
                const helpLink = document.getElementById('help-link');

                if (openBoardLink) {
                    openBoardLink.addEventListener('click', async function (e) {
                        e.preventDefault();
                        console.log('[MENU] Open Board clicked');
                        // Show the open board modal
                        if (openBoardModal) {
                            openBoardModal.style.display = 'flex';
                            if (boardList) {
                                boardList.innerHTML = '<div style="padding:1em; color:#888;">Loading boards...</div>';
                                try {
                                    const resp = await fetch('/list_boards');
                                    if (!resp.ok) throw new Error('Failed to fetch boards: ' + resp.status + ' ' + resp.statusText);
                                    const data = await resp.json();
                                    console.log('[DEBUG] /list_boards response:', data);
                                    if (data && Array.isArray(data.boards) && data.boards.length > 0) {
                                        boardList.innerHTML = '';
                                        data.boards.forEach(board => {
                                            const item = document.createElement('div');
                                            item.textContent = board.name || board.title || 'Untitled Board';
                                            item.style.cursor = 'pointer';
                                            item.style.padding = '0.5em 1em';
                                            item.style.borderBottom = '1px solid #eee';
                                            item.addEventListener('click', function () {
                                                // Placeholder: redirect or load board
                                                window.location.href = '/facilitator?board_id=' + encodeURIComponent(board.id);
                                            });
                                            boardList.appendChild(item);
                                        });
                                    } else {
                                        boardList.innerHTML = '<div style="padding:1em; color:#888;">No boards found.</div>';
                                    }
                                } catch (err) {
                                    console.error('[ERROR] Fetching /list_boards:', err);
                                    boardList.innerHTML = '<div style="padding:1em; color:#c00;">Error loading boards.</div>';
                                }
                            }
                        } else {
                            alert('Open board modal not found.');
                        }
                    });
                }
                if (createBoardLink) {
                    createBoardLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('[MENU] Create New Board clicked');
                        // Already handled below; modal opens
                        const modal = document.getElementById('create-board-modal');
                        const input = document.getElementById('modal-board-name');
                        if (modal && input) {
                            modal.style.display = 'flex';
                            input.value = '';
                            input.focus();
                        } else {
                            alert('Create board modal not found.');
                        }
                    });
                }
                if (exportDataLink) {
                    exportDataLink.addEventListener('click', async function (e) {
                        e.preventDefault();
                        console.log('[MENU] Export Data clicked');
                        try {
                            const resp = await fetch('/export_board?board_id=' + window.boardId);
                            if (!resp.ok) throw new Error('Export failed: ' + resp.statusText);
                            const data = await resp.json();
                            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'board_export.json';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            showNotification('Board exported!');
                        } catch (err) {
                            showNotification('Export failed: ' + err.message, true);
                        }
                    });
                }
                if (importDataLink) {
                    importDataLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('[MENU] Import Data clicked');
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'application/json';
                        fileInput.addEventListener('change', function () {
                            const file = fileInput.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = async function (e) {
                                try {
                                    const resp = await fetch('/import_board', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                                        body: e.target.result
                                    });
                                    const data = await resp.json();
                                    if (data.success) {
                                        showNotification(`✅ <b>Board imported successfully!</b><br>ID: <b>${data.board_id}</b><br>Title: <b>${data.title}</b>`);
                                        setTimeout(() => location.reload(), 5000);
                                    } else {
                                        showNotification('Import failed: ' + (data.error || 'Unknown error'), true);
                                    }
                                } catch (err) {
                                    showNotification('Import failed: ' + err.message, true);
                                }
                            };
                            reader.readAsText(file);
                        });
                        fileInput.click();
                    });
                }
                if (deleteBoardLink) {
                    deleteBoardLink.addEventListener('click', async function (e) {
                        e.preventDefault();
                        console.log('[MENU] Delete Board clicked');
                        if (!window.boardId) {
                            showNotification('No board selected to delete.', true);
                            return;
                        }
                        if (!confirm('Are you sure you want to delete this board? This cannot be undone.')) return;
                        try {
                            const resp = await fetch('/delete_board', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify({ board_id: window.boardId })
                            });
                            const text = await resp.text();
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch (e) {
                                showNotification('Delete failed: invalid server response', true);
                                return;
                            }
                            if (data.success) {
                                showNotification('Board deleted!');
                                setTimeout(() => location.reload(), 3000);
                            } else {
                                showNotification('Delete failed: ' + (data.error || 'Unknown error'), true);
                            }
                        } catch (err) {
                            showNotification('Delete failed: ' + err.message, true);
                        }
                    });
                }
                closeBoardModal.onclick = function () {
                    openBoardModal.style.display = 'none';
                };

                if (addBtn) {
                    addBtn.addEventListener('click', async function () {
                        console.log('=== ADD BUTTON CLICKED ===');
                        let content = document.getElementById('new-thought-input').value.trim();
                        let quadrant = document.getElementById('new-thought-quadrant').value;
                        let boardId = window.boardId || null;
                        if (!content || !boardId) {
                            alert('Thought and board are required!');
                            return;
                        }
                        const btn = this;
                        btn.disabled = true;
                        btn.textContent = 'Adding...';
                        try {
                            if (quadrant === 'auto') {
                                console.log('Classifying with AI...');
                                const classifyResp = await fetch('/classify_thought', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCsrfToken()
                                    },
                                    body: JSON.stringify({ content, board_id: boardId })
                                });
                                const classifyResult = await classifyResp.json();
                                // Multi-thought support
                                if (classifyResult.success && Array.isArray(classifyResult.thoughts)) {
                                    // Add each classified thought
                                    let allSucceeded = true;
                                    for (const t of classifyResult.thoughts) {
                                        const resp = await fetch('/add_thought', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': getCsrfToken()
                                            },
                                            body: JSON.stringify({
                                                content: t.thought,
                                                quadrant: t.quadrant,
                                                board_id: boardId
                                            })
                                        });
                                        let addResult;
                                        try {
                                            addResult = await resp.json();
                                        } catch (e) {
                                            allSucceeded = false;
                                            console.error('Failed to parse add_thought response:', e);
                                            continue;
                                        }
                                        if (!addResult.success) {
                                            allSucceeded = false;
                                            if (resp.status === 409 || (addResult.error && addResult.error.toLowerCase().includes('duplicate'))) {
                                                showNotification('Duplicate: "' + t.thought + '" already exists in ' + t.quadrant + '.', true);
                                            } else {
                                                showNotification('Failed to add: "' + t.thought + '": ' + (addResult.error || 'Unknown error'), true);
                                            }
                                        }
                                    }
                                    document.getElementById('new-thought-input').value = '';
                                    showNotification(allSucceeded ? 'Thoughts added!' : 'Some thoughts were not added.', !allSucceeded);
                                    // Always refresh quadrants after add
                                    window.refreshQuadrants();
                                    setTimeout(() => location.reload(), 1200);
                                    btn.disabled = false;
                                    btn.textContent = 'Add';
                                    return;
                                } else if (classifyResult.success && classifyResult.quadrant) {
                                    // Fallback: single classified thought
                                    const validQuadrants = ['status', 'goal', 'analysis', 'plan'];
                                    let aiQuadrant = (classifyResult.quadrant || '').trim().toLowerCase();
                                    quadrant = validQuadrants.includes(aiQuadrant) ? aiQuadrant : 'status';
                                    if (classifyResult.thought) {
                                        content = classifyResult.thought;
                                    }
                                    console.log('AI classified quadrant:', classifyResult.quadrant, 'Mapped to:', quadrant, 'Thought:', content);
                                } else {
                                    alert('AI classification failed: ' + (classifyResult.error || 'Unknown error'));
                                    btn.disabled = false;
                                    btn.textContent = 'Add';
                                    return;
                                }
                            }
                            console.log('[add_thought] Sending:', { content, quadrant, board_id: boardId });
                            let addResp = await fetch('/add_thought', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify({
                                    content: content,
                                    quadrant: quadrant,
                                    board_id: boardId
                                })
                            });
                            let rawText = await addResp.text();
                            let addResult;
                            try {
                                try {
                                    addResult = JSON.parse(rawText);
                                } catch (jsonErr) {
                                    console.error('Failed to parse JSON:', rawText, jsonErr);
                                    alert('Server returned invalid JSON: ' + rawText);
                                    btn.disabled = false;
                                    btn.textContent = 'Add';
                                    return;
                                }
                            } catch (jsonErr) {
                                console.error('Failed to parse JSON:', rawText, jsonErr);
                                alert('Server returned invalid JSON: ' + rawText);
                                btn.disabled = false;
                                btn.textContent = 'Add';
                                return;
                            }
                            console.log('[add_thought] Parsed JSON:', addResult);
                            if (addResult.success) {
                                showNotification('Thought added!');
                                document.getElementById('new-thought-input').value = '';
                                // Always refresh quadrants after add
                                window.refreshQuadrants();
                                setTimeout(() => location.reload(), 1200);
                            } else {
                                if (addResp.status === 409 || (addResult.error && addResult.error.toLowerCase().includes('duplicate'))) {
                                    showNotification('Duplicate: This thought already exists in this quadrant.', true);
                                    document.getElementById('new-thought-input').value = '';
                                } else {
                                    showNotification('Failed to add thought: ' + (addResult.error || 'Unknown error'), true);
                                }
                            }
                        } catch (e) {
                            showNotification('Error: ' + e.message, true);
                        } finally {
                            btn.disabled = false;
                            btn.textContent = 'Add';
                        }
                    });
                }
            });

            // --- (rest of your JS functions go below, unchanged) ---
            function unhighlightDrop(elem) {
                elem.classList.remove('drop-highlight');
            }
            // --- Notification ---
            // Improved notification logic: ensures minimum display time and prevents flicker
            function showNotification(message, isError, persistent) {
                var n = document.getElementsByClassName('notification')[0];
                if (!n) return;
                n.innerHTML = message;
                n.style.display = 'block';
                n.style.background = isError ? '#d9534f' : '#007bff';
                if (persistent) {
                    // Add close button if not present
                    if (!document.getElementById('notif-close-btn')) {
                        var closeBtn = document.createElement('span');
                        closeBtn.id = 'notif-close-btn';
                        closeBtn.innerHTML = '&times;';
                        closeBtn.style.cssText = 'float:right; cursor:pointer; font-size:1.3em; margin-left:10px;';
                        closeBtn.onclick = function () {
                            n.style.display = 'none';
                            closeBtn.remove();
                        };
                        n.insertBefore(closeBtn, n.firstChild);
                    }
                } else {
                    setTimeout(function () {
                        n.style.display = 'none';
                        if (document.getElementById('notif-close-btn')) {
                            document.getElementById('notif-close-btn').remove();
                        }
                    }, 2200);
                }
            }

            // --- Voice input for new thought ---
            (function () {
                const voiceBtn = document.getElementById('voice-btn');
                if (!voiceBtn) return;
                const voiceIcon = document.getElementById('voice-icon');
                const voiceStatus = document.getElementById('voice-status');
                const input = document.getElementById('new-thought-input');
                let recognition, recognizing = false;

                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.lang = 'en-US';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    recognition.onstart = function () {
                        recognizing = true;
                        voiceStatus.style.display = 'inline';
                        voiceIcon.classList.add('listening');
                    };
                    recognition.onend = function () {
                        recognizing = false;
                        voiceStatus.style.display = 'none';
                        voiceIcon.classList.remove('listening');
                    };
                    recognition.onerror = function (e) {
                        recognizing = false;
                        voiceStatus.style.display = 'none';
                        voiceIcon.classList.remove('listening');
                        showNotification('Speech recognition error: ' + e.error, true);
                    };
                    recognition.onresult = function (e) {
                        if (e.results && e.results[0] && e.results[0][0]) {
                            let transcript = e.results[0][0].transcript.trim();
                            input.value = transcript;
                            input.focus();
                        }
                    };
                    voiceBtn.addEventListener('click', function () {
                        if (recognizing) {
                            recognition.stop();
                        } else {
                            recognition.start();
                        }
                    });
                } else {
                    voiceBtn.disabled = true;
                    voiceBtn.title = 'Speech recognition not supported in this browser.';
                    if (voiceIcon) voiceIcon.style.opacity = 0.3;
                }
            })();

            // --- Drag and Drop ---
            let draggedThoughtId = null;
            function dragThought(event, thoughtId) {
                draggedThoughtId = thoughtId;
                if (event.dataTransfer) {
                    event.dataTransfer.setData('text/plain', thoughtId);
                }
                console.log('dragThought', thoughtId);
            }
            function dragEndThought(event) {
                console.log('dragEndThought');
                draggedThoughtId = null;
            }
            function dropThought(event, quadrant) {
                console.log('dropThought event fired', event, quadrant);
                event.preventDefault();
                event.stopPropagation();
                let thoughtId = draggedThoughtId;
                if (event.dataTransfer) {
                    const dtId = event.dataTransfer.getData('text/plain');
                    if (dtId) thoughtId = dtId;
                }
                console.log('dropThought', thoughtId, quadrant);
                if (thoughtId) {
                    moveThought(thoughtId, quadrant);
                    draggedThoughtId = null;
                }
            }

            // --- Inline Editing ---
            function editThought(span, thoughtId) {
                if (span.isContentEditable) return;
                span.contentEditable = true;
                span.focus();
                span.onblur = function () { saveEdit(span, thoughtId); };
                span.onkeydown = function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        span.blur();
                    }
                };
            }
            function saveEdit(span, thoughtId) {
                span.contentEditable = false;
                fetch('/update_thought', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ thought_id: thoughtId, content: span.textContent })
                })
                    .then(r => r.text())
                    .then(text => {
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (e) {
                            console.error('Invalid JSON from /update_thought:', text);
                            alert('Error updating thought: invalid server response');
                            return;
                        }
                        if (data.success) {
                            alert('Thought updated!');
                            location.reload();
                        } else {
                            alert('Update failed');
                        }
                    });
            }

            // --- Quadrant Dropdown Actions ---
            function thoughtActionDropdown(sel, thoughtId) {
                console.log('[thoughtActionDropdown] called for id:', thoughtId, 'value:', sel.value);
                if (sel.value === 'delete') {
                    console.log('[thoughtActionDropdown] Delete selected for id:', thoughtId);
                    confirmDeleteThought(thoughtId);
                    sel.selectedIndex = Array.from(sel.options).findIndex(opt => opt.value === sel.getAttribute('data-current'));
                } else {
                    moveThought(thoughtId, sel.value);
                    sel.setAttribute('data-current', sel.value);
                }
            }

            console.log('SCRIPT LOADED');
            // --- Add New Thought ---
            window.importBoard = function (event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    fetch('/import_board', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: e.target.result
                    })
                        .then(r => r.json())
                        .then(data => {
                            console.log('[DEBUG] Import response data:', data);
                            console.log('[DEBUG] Import response data:', data);
                            alert('Import response: ' + JSON.stringify(data));
                            if (data.success) {
                                showNotification(`Board imported: (ID: ${data.board_id}, Title: ${data.title})`);
                                // setTimeout(() => location.reload(), 3000); // Disabled for debugging
                            } else {
                                showNotification('Import failed', true);
                            }
                        });
                };
                reader.readAsText(file);
            }
            window.addAISuggestionToBoard = function (content, quadrant, idx) {
                fetch('/add_thought', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                    body: JSON.stringify({ content: content, quadrant: quadrant, board_id: boardId })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            const li = document.getElementById(`ai-suggestion-li-${idx}`);
                            if (li && li.parentNode) {
                                const ul = li.parentNode;
                                // Check if this is the last suggestion BEFORE removal
                                if (ul.children.length === 1) {
                                    ul.innerHTML = '<li style="color:#888;font-style:italic;">No more suggestions.</li>';
                                } else {
                                    ul.removeChild(li);
                                }
                            }
                            if (window.showNotification) {
                                showNotification('Thought added!');
                            } else {
                                alert('Thought added!');
                            }
                            // Always refresh quadrants after add
                            window.refreshQuadrants();
                        } else {
                            alert('Failed to add thought: ' + (data.error || 'Unknown error'));
                        }
                    });
            }
            window.moveAISuggestionToBoard = function (content, quadrant, idx) {
                // This function adds the thought to the selected quadrant, updates the DOM, and removes the suggestion
                fetch('/add_thought', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                    body: JSON.stringify({ content: content, quadrant: quadrant, board_id: boardId })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.thought && data.thought.id) {
                            // Insert the new thought into the correct quadrant list in the DOM
                            const quadrantMap = {
                                'status': 'status-list',
                                'goal': 'goal-list',
                                'analysis': 'analysis-list',
                                'plan': 'plan-list'
                            };
                            const ulId = quadrantMap[quadrant] || 'status-list';
                            const ul = document.getElementById(ulId);
                            if (ul) {
                                // Remove 'No thoughts yet.' placeholder if present
                                const noThoughtsLi = ul.querySelector('li[style*="italic"]');
                                if (noThoughtsLi && ul.children.length === 1) {
                                    ul.innerHTML = '';
                                }
                                // Create new thought li
                                const li = document.createElement('li');
                                li.className = 'thought-item';
                                li.setAttribute('draggable', 'true');
                                li.setAttribute('data-id', data.thought.id);
                                li.ondragstart = function (e) { dragThought(e, data.thought.id); };
                                li.ondragend = function (e) { clearTrashHighlight(); };
                                // Content span
                                const span = document.createElement('span');
                                span.className = 'thought-content';
                                span.textContent = data.thought.content;
                                span.onclick = function () { editThought(span, data.thought.id); };
                                li.appendChild(span);
                                // Controls span
                                const controls = document.createElement('span');
                                controls.className = 'thought-controls';
                                const select = document.createElement('select');
                                select.onchange = function () { thoughtActionDropdown(this, data.thought.id); };
                                select.setAttribute('data-current', quadrant);
                                const options = [
                                    { value: 'status', label: 'Status' },
                                    { value: 'goal', label: 'Goal' },
                                    { value: 'analysis', label: 'Analysis' },
                                    { value: 'plan', label: 'Plan' },
                                    { value: 'delete', label: 'Delete' }
                                ];
                                for (const opt of options) {
                                    const o = document.createElement('option');
                                    o.value = opt.value;
                                    o.textContent = opt.label;
                                    if (opt.value === quadrant) o.selected = true;
                                    select.appendChild(o);
                                }
                                controls.appendChild(select);
                                li.appendChild(controls);
                                ul.appendChild(li);
                            }
                            // Remove the suggestion from the UI
                            const sugLi = document.getElementById(`ai-suggestion-li-${idx}`);
                            if (sugLi && sugLi.parentNode) {
                                const ul = sugLi.parentNode;
                                if (ul.children.length === 1) {
                                    ul.innerHTML = '<li style="color:#888;font-style:italic;">No more suggestions.</li>';
                                } else {
                                    ul.removeChild(sugLi);
                                }
                            }
                            if (window.showNotification) {
                                showNotification('Thought moved!');
                            } else {
                                alert('Thought moved!');
                            }
                            // Always refresh quadrants after move
                            window.refreshQuadrants();
                        } else if (data.success) {
                            // Fallback: just remove from UI
                            const sugLi = document.getElementById(`ai-suggestion-li-${idx}`);
                            if (sugLi && sugLi.parentNode) {
                                const ul = sugLi.parentNode;
                                if (ul.children.length === 1) {
                                    ul.innerHTML = '<li style="color:#888;font-style:italic;">No more suggestions.</li>';
                                } else {
                                    ul.removeChild(sugLi);
                                }
                            }
                            if (window.showNotification) {
                                showNotification('Thought moved!');
                            } else {
                                alert('Thought moved!');
                            }
                            // Always refresh quadrants after move
                            window.refreshQuadrants();
                        } else {
                            alert('Failed to move thought: ' + (data.error || 'Unknown error'));
                        }
                    });
            }

            function closeAISuggestion() {
                document.getElementById('ai-suggestion-box').style.display = 'none';
            }
        </script>

        <script>
            console.log('[DEBUG] index.html script block loaded at LINE 2013');
            window.confirmDeleteThought = function (thoughtId) {
                console.log('[confirmDeleteThought] called for id:', thoughtId);
                // If user opted out, delete immediately
                if (window.sessionStorage && sessionStorage.getItem('skipDeleteConfirm') === '1') {
                    deleteThought(thoughtId);
                    return;
                }
                // Create modal if not present
                let modal = document.getElementById('delete-thought-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'delete-thought-modal';
                    modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.2);z-index:10001;display:flex;align-items:center;justify-content:center;';
                    modal.innerHTML = `
                    <div style="background:#fff;padding:2em;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15);min-width:260px;max-width:90vw;text-align:center;">
                        <h3>Delete Thought?</h3>
                        <div style="margin-bottom:1em;">Are you sure you want to delete this thought?</div>
                        <div style="margin-bottom:1em;">
                            <label style="font-size:0.98em;cursor:pointer;">
                                <input type="checkbox" id="delete-thought-dontshow" style="margin-right:0.5em;vertical-align:middle;">Don't show this again for this session
                            </label>
                        </div>
                        <button id="delete-thought-confirm-btn" style="background:#c00;color:#fff;border:none;padding:0.5em 1.5em;border-radius:5px;font-size:1em;margin-right:1em;">Delete</button>
                        <button id="delete-thought-cancel-btn" style="background:#eee;color:#333;border:none;padding:0.5em 1.5em;border-radius:5px;font-size:1em;">Cancel</button>
                    </div>
                `;
                    document.body.appendChild(modal);
                } else {
                    modal.style.display = 'flex';
                }
                // Attach handlers
                document.getElementById('delete-thought-confirm-btn').onclick = function () {
                    modal.style.display = 'none';
                    const dontShow = document.getElementById('delete-thought-dontshow');
                    if (dontShow && dontShow.checked && window.sessionStorage) {
                        sessionStorage.setItem('skipDeleteConfirm', '1');
                    }
                    deleteThought(thoughtId);
                };
                document.getElementById('delete-thought-cancel-btn').onclick = function () {
                    modal.style.display = 'none';
                };
            };
            function deleteThought(thoughtId) {
                console.log('[deleteThought] called for id:', thoughtId);
                fetch('/delete_thought', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ thought_id: thoughtId })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        }
                    });
            }
            console.log('SCRIPT EXECUTED');
            // --- CSRF Token Helper ---
            function getCsrfToken() {
                const meta = document.querySelector('meta[name="csrf-token"]');
                return meta ? meta.getAttribute('content') : '';
            }

            // --- Add/Edit/Delete/Move/AI Handler Attachments ---
            document.addEventListener('DOMContentLoaded', function () {
                // --- Add Thought Handler ---
                const addBtn = document.getElementById('add-thought-btn');
                if (addBtn) {

                }

                // --- Move Thought Handler (drag-and-drop) ---
                // --- Helper to refresh all quadrants from backend ---
                window.refreshQuadrants = async function () {
                    console.log('[DEBUG] refreshQuadrants called');
                    if (!window.boardId) return;
                    try {
                        const resp = await fetch(`/export_board?board_id=${window.boardId}`);
                        const data = await resp.json();
                        console.log('[DEBUG] /export_board response:', data);
                        if (data.success && Array.isArray(data.thoughts)) {
                            // Clear all quadrant lists
                            ['status', 'goal', 'analysis', 'plan'].forEach(q => {
                                const ul = document.getElementById(q + '-list');
                                if (ul) ul.innerHTML = '';
                            });
                            // Group thoughts by quadrant
                            const grouped = { status: [], goal: [], analysis: [], plan: [] };
                            data.thoughts.forEach(t => {
                                if (grouped[t.quadrant]) grouped[t.quadrant].push(t);
                            });
                            // Render each quadrant
                            Object.entries(grouped).forEach(([q, arr]) => {
                                const ul = document.getElementById(q + '-list');
                                if (ul) {
                                    if (!arr.length) {
                                        ul.innerHTML = '<li style="color:#aaa;font-style:italic;">No thoughts yet.</li>';
                                    } else {
                                        ul.innerHTML = arr.map(t =>
                                            `<li class="thought-item" draggable="true" ondragstart="dragThought(event, '${t.id}')" ondragend="clearTrashHighlight()" data-id="${t.id}">
                                <span class="thought-content" onclick="editThought(this, ${t.id})">${t.content}</span>
                                <span class="thought-controls">
                                    <select onchange="thoughtActionDropdown(this, ${t.id})" data-current="${t.quadrant}">
                                        <option value="status"${t.quadrant == 'status' ? ' selected' : ''}>Status</option>
                                        <option value="goal"${t.quadrant == 'goal' ? ' selected' : ''}>Goal</option>
                                        <option value="analysis"${t.quadrant == 'analysis' ? ' selected' : ''}>Analysis</option>
                                        <option value="plan"${t.quadrant == 'plan' ? ' selected' : ''}>Plan</option>
                                        <option value="delete">Delete</option>
                                    </select>
                                </span>
                            </li>`
                                        ).join('');
                                        console.log(`[DEBUG] Rendered quadrant '${q}' with ${arr.length} items.`);
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Failed to refresh quadrants:', e);
                    }
                };

                window.moveThought = function (thoughtId, quadrant, fromAISuggestionIdx = null) {
                    console.log('moveThought called', thoughtId, quadrant, fromAISuggestionIdx);
                    fetch('/move_thought', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ thought_id: thoughtId, quadrant: quadrant, board_id: window.boardId })
                    })
                        .then(r => r.text())
                        .then(text => {
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch (e) {
                                console.error('Invalid JSON from /move_thought:', text);
                                alert('Error moving thought: invalid server response');
                                return;
                            }
                            if (data.success) {
                                if (fromAISuggestionIdx !== null) {
                                    // Remove the suggestion from the UI only (do not reload)
                                    const li = document.getElementById(`ai-suggestion-li-${fromAISuggestionIdx}`);
                                    if (li && li.parentNode) {
                                        const ul = li.parentNode;
                                        if (ul.children.length === 1) {
                                            ul.innerHTML = '<li style="color:#888;font-style:italic;">No more suggestions.</li>';
                                        } else {
                                            ul.removeChild(li);
                                        }
                                    }
                                    if (window.showNotification) {
                                        showNotification('Thought moved!');
                                    } else {
                                        alert('Thought moved!');
                                    }
                                } else {
                                    setTimeout(() => location.reload(), 500);
                                }
                            } else {
                                alert('Failed to move thought.');
                            }
                        })
                        .catch(e => {
                            alert('Error moving thought: ' + e.message);
                        });
                };

                // --- Inline Editing ---
                window.editThought = function (span, thoughtId) {
                    if (span.isContentEditable) return;
                    span.contentEditable = true;
                    span.focus();
                    span.onblur = function () { window.saveEdit(span, thoughtId); };
                    span.onkeydown = function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            span.blur();
                        }
                    };
                };
                window.saveEdit = function (span, thoughtId) {
                    span.contentEditable = false;
                    fetch('/update_thought', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ thought_id: thoughtId, content: span.textContent })
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                alert('Thought updated!');
                                location.reload();
                            } else {
                                alert('Update failed');
                            }
                        });
                };

                // --- Delete Thought ---



                // --- AI Actions ---
                const aiBtn = document.getElementById('ai-submit');
                if (aiBtn) {
                    aiBtn.addEventListener('click', async function () {
                        console.log('AI handler clicked');
                        const action = document.getElementById('ai-action').value;
                        const input = document.getElementById('ai-input').value.trim();
                        const output = document.getElementById('ai-output');
                        if (!input && action !== 'minutes' && action !== 'suggest') {
                            output.textContent = 'Input required.';
                            return;
                        }
                        output.textContent = 'Thinking...';
                        let endpoint = '';
                        let payload = {};
                        if (action === 'suggest') {
                            // Gather thoughts from all quadrants in the DOM
                            function getQuadrantList(id) {
                                const ul = document.getElementById(id);
                                if (!ul) return [];
                                return Array.from(ul.querySelectorAll('li .thought-content'))
                                    .map(span => span.textContent.trim())
                                    .filter(Boolean);
                            }
                            const status = getQuadrantList('status-list');
                            const goal = getQuadrantList('goal-list');
                            const analysis = getQuadrantList('analysis-list');
                            const plan = getQuadrantList('plan-list');
                            // For compatibility with backend, treat 'problems' as status+goal, 'obstacles' as analysis+plan
                            payload = { problems: status.concat(goal), obstacles: analysis.concat(plan) };
                            endpoint = '/suggest_solution/';
                        } else if (action === 'rewrite') {
                            endpoint = '/rewrite_thought';
                            payload = { thought: input, board_id: window.boardId };
                        } else if (action === 'brainstorm') {
                            endpoint = '/brainstorm';
                            payload = { topic: input, board_id: window.boardId };
                        } else if (action === 'minutes') {
                            endpoint = '/meeting_minutes';
                            payload = { summary: input, board_id: window.boardId };
                        }
                        try {
                            // Always send a fresh CSRF token with each POST
                            const resp = await fetch(endpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify(payload)
                            });
                            const result = await resp.json();
                            console.log('[AI] Response:', result);
                            let suggestions = null;
                            if (Array.isArray(result.suggestions)) {
                                suggestions = result.suggestions;
                            } else if (result.suggestions && Array.isArray(result.suggestions.add_to_quadrant)) {
                                suggestions = result.suggestions.add_to_quadrant;
                            }
                            if (suggestions) {
                                // Map 'thought' to 'content' if needed for compatibility
                                suggestions = suggestions.map(s => {
                                    if (typeof s === 'object' && s.thought && !s.content) {
                                        return { ...s, content: s.thought };
                                    }
                                    return s;
                                });
                                // Render suggestions as interactive list (handle both string and object suggestions)
                                output.innerHTML = '<ul style="list-style:disc inside; padding-left:1.2em;">' +
                                    suggestions.map((s, idx) => {
                                        let quadrantOptions = ['status', 'goal', 'analysis', 'plan'];
                                        let defaultQuadrant = 'status';
                                        // If s is a string, treat it as a suggestion with no quadrant (default to status)
                                        if (typeof s === 'string') {
                                            let optionsHtml = quadrantOptions.map(q => `<option value="${q}"${q === defaultQuadrant ? ' selected' : ''}>${q.charAt(0).toUpperCase() + q.slice(1)}</option>`).join('');
                                            return `
<li style="margin-bottom:0.5em;" id="ai-suggestion-li-${idx}">
  <span>${s}</span>
  <select id="ai-suggestion-quadrant-${idx}" style="margin-left:1em;">
    ${optionsHtml}
  </select>
  <button 
    data-content="${s.replace(/&/g, '&amp;').replace(/"/g, '&quot;')}"
    onclick="moveAISuggestionToBoard(this.getAttribute('data-content'), document.getElementById('ai-suggestion-quadrant-${idx}').value, ${idx})">
    Move
  </button>
</li>
`;
                                        }
                                        // If s is an object with content/quadrant, use previous logic
                                        let safeContent = (typeof s.content === 'string' ? s.content : String(s.content)).replace(/'/g, "\\'");
                                        let displayContent = typeof s.content === 'string' ? s.content : (s.content && typeof s.content === 'object' && typeof s.content.content === 'string' ? s.content.content : (s.content && typeof s.content === 'object' ? JSON.stringify(s.content) : String(s.content)));
                                        if (s.quadrant === 'does_not_belong' || s.quadrant === 'none' || s.quadrant === 'not_applicable') {
                                            // Show as 'Likely doesn\'t belong' with Delete button
                                            return `
<li style="margin-bottom:0.5em;background:#fff7f7;" id="ai-suggestion-li-${idx}">
  <span class="thought-content">${displayContent}</span>
  <span style="margin-left:0.7em;font-size:0.93em;color:#e55;font-style:italic;">[Likely doesn\'t belong]</span>
  <button style="margin-left:1em;background:#e55;color:#fff;border:none;padding:0.3em 1em;border-radius:4px;" onclick="window.removeAISuggestion(${idx})">Delete</button>
</li>
`;
                                        } else {
                                            let optionsHtml = quadrantOptions.map(q =>
                                                `<option value="${q}"${s.quadrant === q ? ' selected' : ''}>${q.charAt(0).toUpperCase() + q.slice(1)}</option>`
                                            ).join('');
                                            return `
<li style="margin-bottom:0.5em;" id="ai-suggestion-li-${idx}">
  <span>${typeof s.content === 'string' ? s.content : (s.content && typeof s.content === 'object' && typeof s.content.content === 'string' ? s.content.content : (s.content && typeof s.content === 'object' ? JSON.stringify(s.content) : String(s.content)))}</span>
  <span style="margin-left:0.7em;font-size:0.93em;color:#888;">[${s.quadrant.charAt(0).toUpperCase() + s.quadrant.slice(1)}]</span>
  <select id="ai-suggestion-quadrant-${idx}" style="margin-left:1em;">
    ${optionsHtml}
  </select>
  <button 
  data-content="${typeof s.content === 'string' ? s.content.replace(/&/g, '&amp;').replace(/"/g, '&quot;') : (s.content && typeof s.content === 'object' && typeof s.content.content === 'string' ? s.content.content.replace(/&/g, '&amp;').replace(/"/g, '&quot;') : String(s.content).replace(/&/g, '&amp;').replace(/"/g, '&quot;'))}"
  onclick="moveAISuggestionToBoard(this.getAttribute('data-content'), document.getElementById('ai-suggestion-quadrant-${idx}').value, ${idx})">
  Move
</button>
</li>
`;
                                        }
                                    }).join('') + '</ul>';
                            } else if (result.success && result.result && typeof result.result === 'string') {
                                // Render result string with line breaks
                                output.innerHTML = `<pre style='white-space:pre-wrap;font-family:inherit;'>${result.result.replace(/\n/g, '<br>')}</pre>`;
                            } else if (result.error) {
                                output.textContent = 'Error: ' + result.error;
                            } else {
                                output.textContent = 'No response.';
                            }
                        } catch (e) {
                            output.textContent = 'Error: ' + e.message;
                        }
                    });
                }

                // --- Drag and Drop Implementation ---
                window.dragThought = function (event, thoughtId) {
                    console.log('dragThought called', thoughtId);
                    event.dataTransfer.setData('text/plain', thoughtId);
                    // Optionally: highlight drop zones
                };
                window.dropThought = function (event, quadrant) {
                    event.preventDefault();
                    const thoughtId = event.dataTransfer.getData('text/plain');
                    console.log('dropThought called', thoughtId, quadrant);
                    if (thoughtId && quadrant) {
                        moveThought(thoughtId, quadrant);
                    }
                };
                window.highlightDrop = function (event, elem) {
                    elem.classList.add('drop-highlight');
                    event.preventDefault();
                };
                document.getElementById('modal-cancel-board-btn').onclick = function () {
                    document.getElementById('create-board-modal').style.display = 'none';
                };
                document.getElementById('modal-board-name').onkeydown = function (e) {
                    if (e.key === 'Enter') {
                        document.getElementById('modal-create-board-btn').click();
                    }
                };
                document.getElementById('modal-create-board-btn').onclick = async function () {
                    const name = document.getElementById('modal-board-name').value.trim();
                    if (!name) {
                        showNotification('Please enter a board name.', true);
                        document.getElementById('modal-board-name').focus();
                        return;
                    }
                    try {
                        const formData = new FormData();
                        formData.append('new_board_title', name);
                        if (typeof getCsrfToken === 'function') {
                            formData.append('csrf_token', getCsrfToken());
                        }
                        let resp = await fetch('/facilitator', {
                            method: 'POST',
                            body: formData
                        });
                        if (resp.redirected) {
                            window.location.href = resp.url;
                            return;
                        }
                        showNotification('Failed to create board.', true);
                    } catch (err) {
                        showNotification('Error creating board.', true);
                    } finally {
                        document.getElementById('create-board-modal').style.display = 'none';
                    }
                };


            });
        </script>
        <!-- Board Menu Modal -->
        <div id="open-board-modal"
            style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.2); z-index:10000; align-items:center; justify-content:center;">
            <div
                style="background:#fff; padding:2rem; border-radius:8px; min-width:300px; max-width:90vw; box-shadow:0 4px 16px rgba(0,0,0,0.15);">
                <h3>Select a Board</h3>
                <ul id="board-list" style="list-style:none; padding:0; margin:0 0 1rem 0;"></ul>
                <button id="close-board-modal" style="margin-top:1rem;">Close</button>
                <button id="delete-selected-board"
                    style="background:#c00;color:#fff;border:none;padding:0.5em 1em;border-radius:5px;font-size:1em;display:none;">Delete
                    Selected Board</button>
            </div>
        </div>
        <script>
            console.log('[DEBUG] index.html script block loaded at LINE 2013');
            window.confirmDeleteThought = function (thoughtId) {
                console.log('[confirmDeleteThought] called for id:', thoughtId);
                // If user opted out, delete immediately
                if (window.sessionStorage && sessionStorage.getItem('skipDeleteConfirm') === '1') {
                    deleteThought(thoughtId);
                    return;
                }
                // Create modal if not present
                let modal = document.getElementById('delete-thought-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'delete-thought-modal';
                    modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.2);z-index:10001;display:flex;align-items:center;justify-content:center;';
                    modal.innerHTML = `
                    <div style="background:#fff;padding:2em;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15);min-width:260px;max-width:90vw;text-align:center;">
                        <h3>Delete Thought?</h3>
                        <div style="margin-bottom:1em;">Are you sure you want to delete this thought?</div>
                        <div style="margin-bottom:1em;">
                            <label style="font-size:0.98em;cursor:pointer;">
                                <input type="checkbox" id="delete-thought-dontshow" style="margin-right:0.5em;vertical-align:middle;">Don't show this again for this session
                            </label>
                        </div>
                        <button id="delete-thought-confirm-btn" style="background:#c00;color:#fff;border:none;padding:0.5em 1.5em;border-radius:5px;font-size:1em;margin-right:1em;">Delete</button>
                        <button id="delete-thought-cancel-btn" style="background:#eee;color:#333;border:none;padding:0.5em 1.5em;border-radius:5px;font-size:1em;">Cancel</button>
                    </div>
                `;
                    document.body.appendChild(modal);
                } else {
                    modal.style.display = 'flex';
                }
                // Attach handlers
                document.getElementById('delete-thought-confirm-btn').onclick = function () {
                    modal.style.display = 'none';
                    const dontShow = document.getElementById('delete-thought-dontshow');
                    if (dontShow && dontShow.checked && window.sessionStorage) {
                        sessionStorage.setItem('skipDeleteConfirm', '1');
                    }
                    deleteThought(thoughtId);
                };
                document.getElementById('delete-thought-cancel-btn').onclick = function () {
                    modal.style.display = 'none';
                };
            };
            function deleteThought(thoughtId) {
                console.log('[deleteThought] called for id:', thoughtId);
                fetch('/delete_thought', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ thought_id: thoughtId })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        }
                    });
            }
            console.log('SCRIPT EXECUTED');
            // --- CSRF Token Helper ---
            function getCsrfToken() {
                const meta = document.querySelector('meta[name="csrf-token"]');
                return meta ? meta.getAttribute('content') : '';
            }

            // --- Add/Edit/Delete/Move/AI Handler Attachments ---
            document.addEventListener('DOMContentLoaded', function () {
                // --- Add Thought Handler ---
                const addBtn = document.getElementById('add-thought-btn');
                if (addBtn) {

                }

                // --- Move Thought Handler (drag-and-drop) ---
                // --- Helper to refresh all quadrants from backend ---
                window.refreshQuadrants = async function () {
                    console.log('[DEBUG] refreshQuadrants called');
                    if (!window.boardId) return;
                    try {
                        const resp = await fetch(`/export_board?board_id=${window.boardId}`);
                        const data = await resp.json();
                        console.log('[DEBUG] /export_board response:', data);
                        if (data.success && Array.isArray(data.thoughts)) {
                            // Clear all quadrant lists
                            ['status', 'goal', 'analysis', 'plan'].forEach(q => {
                                const ul = document.getElementById(q + '-list');
                                if (ul) ul.innerHTML = '';
                            });
                            // Group thoughts by quadrant
                            const grouped = { status: [], goal: [], analysis: [], plan: [] };
                            data.thoughts.forEach(t => {
                                if (grouped[t.quadrant]) grouped[t.quadrant].push(t);
                            });
                            // Render each quadrant
                            Object.entries(grouped).forEach(([q, arr]) => {
                                const ul = document.getElementById(q + '-list');
                                if (ul) {
                                    if (!arr.length) {
                                        ul.innerHTML = '<li style="color:#aaa;font-style:italic;">No thoughts yet.</li>';
                                    } else {
                                        ul.innerHTML = arr.map(t =>
                                            `<li class="thought-item" draggable="true" ondragstart="dragThought(event, '${t.id}')" ondragend="clearTrashHighlight()" data-id="${t.id}">
                                <span class="thought-content" onclick="editThought(this, ${t.id})">${t.content}</span>
                                <span class="thought-controls">
                                    <select onchange="thoughtActionDropdown(this, ${t.id})" data-current="${t.quadrant}">
                                        <option value="status"${t.quadrant == 'status' ? ' selected' : ''}>Status</option>
                                        <option value="goal"${t.quadrant == 'goal' ? ' selected' : ''}>Goal</option>
                                        <option value="analysis"${t.quadrant == 'analysis' ? ' selected' : ''}>Analysis</option>
                                        <option value="plan"${t.quadrant == 'plan' ? ' selected' : ''}>Plan</option>
                                        <option value="delete">Delete</option>
                                    </select>
                                </span>
                            </li>`
                                        ).join('');
                                        console.log(`[DEBUG] Rendered quadrant '${q}' with ${arr.length} items.`);
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Failed to refresh quadrants:', e);
                    }
                };

                window.moveThought = function (thoughtId, quadrant, fromAISuggestionIdx = null) {
                    console.log('moveThought called', thoughtId, quadrant, fromAISuggestionIdx);
                    fetch('/move_thought', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ thought_id: thoughtId, quadrant: quadrant, board_id: window.boardId })
                    })
                        .then(r => r.text())
                        .then(text => {
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch (e) {
                                console.error('Invalid JSON from /move_thought:', text);
                                alert('Error moving thought: invalid server response');
                                return;
                            }
                            if (data.success) {
                                if (fromAISuggestionIdx !== null) {
                                    // Remove the suggestion from the UI only (do not reload)
                                    const li = document.getElementById(`ai-suggestion-li-${fromAISuggestionIdx}`);
                                    if (li && li.parentNode) {
                                        const ul = li.parentNode;
                                        if (ul.children.length === 1) {
                                            ul.innerHTML = '<li style="color:#888;font-style:italic;">No more suggestions.</li>';
                                        } else {
                                            ul.removeChild(li);
                                        }
                                    }
                                    if (window.showNotification) {
                                        showNotification('Thought moved!');
                                    } else {
                                        alert('Thought moved!');
                                    }
                                } else {
                                    setTimeout(() => location.reload(), 500);
                                }
                            } else {
                                alert('Failed to move thought.');
                            }
                        })
                        .catch(e => {
                            alert('Error moving thought: ' + e.message);
                        });
                };

                // --- Inline Editing ---
                window.editThought = function (span, thoughtId) {
                    if (span.isContentEditable) return;
                    span.contentEditable = true;
                    span.focus();
                    span.onblur = function () { window.saveEdit(span, thoughtId); };
                    span.onkeydown = function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            span.blur();
                        }
                    };
                };
                window.saveEdit = function (span, thoughtId) {
                    span.contentEditable = false;
                    fetch('/update_thought', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ thought_id: thoughtId, content: span.textContent })
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                alert('Thought updated!');
                                location.reload();
                            } else {
                                alert('Update failed');
                            }
                        });
                };

                // --- Delete Thought ---



                // --- AI Actions ---
                const aiBtn = document.getElementById('ai-submit');
                if (aiBtn) {
                    aiBtn.addEventListener('click', async function () {
                        console.log('AI handler clicked');
                        const action = document.getElementById('ai-action').value;
                        const input = document.getElementById('ai-input').value.trim();
                        const output = document.getElementById('ai-output');
                        if (!input && action !== 'minutes' && action !== 'suggest') {
                            output.textContent = 'Input required.';
                            return;
                        }
                        output.textContent = 'Thinking...';
                        let endpoint = '';
                        let payload = {};
                        if (action === 'suggest') {
                            // Gather thoughts from all quadrants in the DOM
                            function getQuadrantList(id) {
                                const ul = document.getElementById(id);
                                if (!ul) return [];
                                return Array.from(ul.querySelectorAll('li .thought-content'))
                                    .map(span => span.textContent.trim())
                                    .filter(Boolean);
                            }
                            const status = getQuadrantList('status-list');
                            const goal = getQuadrantList('goal-list');
                            const analysis = getQuadrantList('analysis-list');
                            const plan = getQuadrantList('plan-list');
                            // For compatibility with backend, treat 'problems' as status+goal, 'obstacles' as analysis+plan
                            payload = { problems: status.concat(goal), obstacles: analysis.concat(plan) };
                            endpoint = '/suggest_solution/';
                        } else if (action === 'rewrite') {
                            endpoint = '/rewrite_thought';
                            payload = { thought: input, board_id: window.boardId };
                        } else if (action === 'brainstorm') {
                            endpoint = '/brainstorm';
                            payload = { topic: input, board_id: window.boardId };
                        } else if (action === 'minutes') {
                            endpoint = '/meeting_minutes';
                            payload = { summary: input, board_id: window.boardId };
                        }
                        try {
                            // Always send a fresh CSRF token with each POST
                            const resp = await fetch(endpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify(payload)
                            });
                            const result = await resp.json();
                            console.log('[AI] Response:', result);
                            let suggestions = null;
                            if (Array.isArray(result.suggestions)) {
                                suggestions = result.suggestions;
                            } else if (result.suggestions && Array.isArray(result.suggestions.add_to_quadrant)) {
                                suggestions = result.suggestions.add_to_quadrant;
                            }
                            if (suggestions) {
                                // Map 'thought' to 'content' if needed for compatibility
                                suggestions = suggestions.map(s => {
                                    if (typeof s === 'object' && s.thought && !s.content) {
                                        return { ...s, content: s.thought };
                                    }
                                    return s;
                                });
                                // Render suggestions as interactive list (handle both string and object suggestions)
                                output.innerHTML = '<ul style="list-style:disc inside; padding-left:1.2em;">' +
                                    suggestions.map((s, idx) => {
                                        let quadrantOptions = ['status', 'goal', 'analysis', 'plan'];
                                        let defaultQuadrant = 'status';
                                        // If s is a string, treat it as a suggestion with no quadrant (default to status)
                                        if (typeof s === 'string') {
                                            let optionsHtml = quadrantOptions.map(q => `<option value="${q}"${q === defaultQuadrant ? ' selected' : ''}>${q.charAt(0).toUpperCase() + q.slice(1)}</option>`).join('');
                                            return `
<li style="margin-bottom:0.5em;" id="ai-suggestion-li-${idx}">
  <span>${s}</span>
  <select id="ai-suggestion-quadrant-${idx}" style="margin-left:1em;">
    ${optionsHtml}
  </select>
  <button 
    data-content="${s.replace(/&/g, '&amp;').replace(/"/g, '&quot;')}"
    onclick="moveAISuggestionToBoard(this.getAttribute('data-content'), document.getElementById('ai-suggestion-quadrant-${idx}').value, ${idx})">
    Move
  </button>
</li>
`;
                                        }
                                        // If s is an object with content/quadrant, use previous logic
                                        let safeContent = (typeof s.content === 'string' ? s.content : String(s.content)).replace(/'/g, "\\'");
                                        let displayContent = typeof s.content === 'string' ? s.content : (s.content && typeof s.content === 'object' && typeof s.content.content === 'string' ? s.content.content : (s.content && typeof s.content === 'object' ? JSON.stringify(s.content) : String(s.content)));
                                        if (s.quadrant === 'does_not_belong' || s.quadrant === 'none' || s.quadrant === 'not_applicable') {
                                            // Show as 'Likely doesn\'t belong' with Delete button
                                            return `
<li style="margin-bottom:0.5em;background:#fff7f7;" id="ai-suggestion-li-${idx}">
  <span class="thought-content">${displayContent}</span>
  <span style="margin-left:0.7em;font-size:0.93em;color:#e55;font-style:italic;">[Likely doesn\'t belong]</span>
  <button style="margin-left:1em;background:#e55;color:#fff;border:none;padding:0.3em 1em;border-radius:4px;" onclick="window.removeAISuggestion(${idx})">Delete</button>
</li>
`;
                                        } else {
                                            let optionsHtml = quadrantOptions.map(q =>
                                                `<option value="${q}"${s.quadrant === q ? ' selected' : ''}>${q.charAt(0).toUpperCase() + q.slice(1)}</option>`
                                            ).join('');
                                            return `
<li style="margin-bottom:0.5em;" id="ai-suggestion-li-${idx}">
  <span>${typeof s.content === 'string' ? s.content : (s.content && typeof s.content === 'object' && typeof s.content.content === 'string' ? s.content.content : (s.content && typeof s.content === 'object' ? JSON.stringify(s.content) : String(s.content)))}</span>
  <span style="margin-left:0.7em;font-size:0.93em;color:#888;">[${s.quadrant.charAt(0).toUpperCase() + s.quadrant.slice(1)}]</span>
  <select id="ai-suggestion-quadrant-${idx}" style="margin-left:1em;">
    ${optionsHtml}
  </select>
  <button 
  data-content="${typeof s.content === 'string' ? s.content.replace(/&/g, '&amp;').replace(/"/g, '&quot;') : (s.content && typeof s.content === 'object' && typeof s.content.content === 'string' ? s.content.content.replace(/&/g, '&amp;').replace(/"/g, '&quot;') : String(s.content).replace(/&/g, '&amp;').replace(/"/g, '&quot;'))}"
  onclick="moveAISuggestionToBoard(this.getAttribute('data-content'), document.getElementById('ai-suggestion-quadrant-${idx}').value, ${idx})">
  Move
</button>
</li>
`;
                                        }
                                    }).join('') + '</ul>';
                            } else if (result.success && result.result && typeof result.result === 'string') {
                                // Render result string with line breaks
                                output.innerHTML = `<pre style='white-space:pre-wrap;font-family:inherit;'>${result.result.replace(/\n/g, '<br>')}</pre>`;
                            } else if (result.error) {
                                output.textContent = 'Error: ' + result.error;
                            } else {
                                output.textContent = 'No response.';
                            }
                        } catch (e) {
                            output.textContent = 'Error: ' + e.message;
                        }
                    });
                }

                // --- Drag and Drop Implementation ---
                window.dragThought = function (event, thoughtId) {
                    console.log('dragThought called', thoughtId);
                    event.dataTransfer.setData('text/plain', thoughtId);
                    // Optionally: highlight drop zones
                };
                window.dropThought = function (event, quadrant) {
                    event.preventDefault();
                    const thoughtId = event.dataTransfer.getData('text/plain');
                    console.log('dropThought called', thoughtId, quadrant);
                    if (thoughtId && quadrant) {
                        moveThought(thoughtId, quadrant);
                    }
                };
                window.highlightDrop = function (event, elem) {
                    elem.classList.add('drop-highlight');
                    event.preventDefault();
                };
                document.getElementById('modal-cancel-board-btn').onclick = function () {
                    document.getElementById('create-board-modal').style.display = 'none';
                };
                document.getElementById('modal-board-name').onkeydown = function (e) {
                    if (e.key === 'Enter') {
                        document.getElementById('modal-create-board-btn').click();
                    }
                };
                document.getElementById('modal-create-board-btn').onclick = async function () {
                    const name = document.getElementById('modal-board-name').value.trim();
                    if (!name) {
                        showNotification('Please enter a board name.', true);
                        document.getElementById('modal-board-name').focus();
                        return;
                    }
                    try {
                        const formData = new FormData();
                        formData.append('new_board_title', name);
                        if (typeof getCsrfToken === 'function') {
                            formData.append('csrf_token', getCsrfToken());
                        }
                        let resp = await fetch('/facilitator', {
                            method: 'POST',
                            body: formData
                        });
                        if (resp.redirected) {
                            window.location.href = resp.url;
                            return;
                        }
                        showNotification('Failed to create board.', true);
                    } catch (err) {
                        showNotification('Error creating board.', true);
                    } finally {
                        document.getElementById('create-board-modal').style.display = 'none';
                    }
                };


            });
        </script>
        <!-- Help overlay (hidden by default) -->
        <div id="help-overlay" style="display:none;">
            <div id="help-circles-container"></div>
            <div id="help-tooltip" style="display:none;"></div>
            <button onclick="hideHelpOverlay()" id="help-close-btn"
                style="position:fixed;top:30px;right:30px;z-index:1101;">Close Help</button>
        </div>

        <style>
            #help-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3);
                z-index: 1000;
            }

            .help-circle {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #3498db;
                color: white;
                font-size: 1.5em;
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                border: 3px solid #fff;
                z-index: 1100;
                transition: top 0.2s, left 0.2s;
            }

            #help-tooltip {
                position: fixed;
                left: 120px;
                top: 120px;
                background: #fff;
                color: #333;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                z-index: 1101;
                max-width: 320px;
            }
        </style>

        <script>
            console.log('[DEBUG] index.html script block loaded at LINE 2472');
            function showHelpOverlay() {
                document.getElementById('help-overlay').style.display = 'block';
                document.getElementById('help-tooltip').style.display = 'none';
                // Remove any existing help circles
                const circlesContainer = document.getElementById('help-circles-container');
                circlesContainer.innerHTML = '';
                // Target 1: Input field ("Tell me what's going on...")
                var input = document.querySelector('.add-thought textarea');
                if (input) {
                    const rect = input.getBoundingClientRect();
                    createHelpCircle(1, rect.left - 50, rect.top + rect.height / 2 - 20);
                }
                // Target 2: Quadrants container
                var quadrants = document.querySelector('.quadrants');
                if (quadrants) {
                    const rect = quadrants.getBoundingClientRect();
                    createHelpCircle(2, rect.left - 50, rect.top + 30);
                }
                // Target 3: AI Actions panel (look for .ai-panel or similar)
                var aiPanel = document.querySelector('.ai-panel');
                if (aiPanel) {
                    const rect = aiPanel.getBoundingClientRect();
                    createHelpCircle(3, rect.left - 50, rect.top + 30);
                }
            }
            function hideHelpOverlay() {
                document.getElementById('help-overlay').style.display = 'none';
                document.getElementById('help-tooltip').style.display = 'none';
                document.getElementById('help-circles-container').innerHTML = '';
            }
            function createHelpCircle(num, left, top) {
                const circle = document.createElement('div');
                circle.className = 'help-circle';
                circle.textContent = num;
                circle.style.left = left + 'px';
                circle.style.top = top + 'px';
                circle.onclick = function () { showHelpText(num, left, top); };
                document.getElementById('help-circles-container').appendChild(circle);
            }
            function showHelpText(num, left, top) {
                const tooltip = document.getElementById('help-tooltip');
                let text = '';
                if (num === 1) {
                    text = "<b>Start here:</b> Enter information (written or spoken) about issues you're facing with which you'd like help.";
                } else if (num === 2) {
                    text = "<b>Quadrants:</b> Populate the 4 quadrants with information about the issue you'd like help with. Move the items in the quadrants around so that they're in the appropriate quadrant.";
                } else if (num === 3) {
                    text = "<b>Additional AI Actions:</b> Get some additional help here - rewrite thoughts, brainstorm ideas, check meeting minutes and finally, when you believe your 4 quadrants are in decent shape, try the '4 Quadrants Analysis'.";
                }
                tooltip.innerHTML = text;
                tooltip.style.display = 'block';
                // Place tooltip near the clicked circle
                tooltip.style.left = (left + 60) + 'px';
                tooltip.style.top = (top - 10) + 'px';
            }

            window.addEventListener('scroll', function () {
                if (document.getElementById('help-overlay').style.display === 'block') {
                    showHelpOverlay();
                }
            });
            window.addEventListener('resize', function () {
                if (document.getElementById('help-overlay').style.display === 'block') {
                    showHelpOverlay();
                }
            });
        </script>

        <script>
            console.log('[DEBUG] index.html script block loaded at LINE 2541');
            // CSRF Token Auto-Refresh
            function refreshCsrfToken() {
                fetch('/get_csrf_token')
                    .then(res => res.json())
                    .then(data => {
                        document.querySelectorAll('meta[name="csrf-token"]').forEach(meta => {
                            meta.setAttribute('content', data.csrf_token);
                        });
                    });
            }
            // Refresh every 10 minutes
            setInterval(refreshCsrfToken, 10 * 60 * 1000);

            // Helper to get latest CSRF token
            function getCsrfToken() {
                var meta = document.querySelector('meta[name="csrf-token"]');
                return meta ? meta.getAttribute('content') : '';
            }

            // Patch fetch to always use latest CSRF token if X-CSRFToken header is set
            const origFetch = window.fetch;
            window.fetch = function (input, init) {
                if (init && init.headers && init.headers['X-CSRFToken'] !== undefined) {
                    init.headers['X-CSRFToken'] = getCsrfToken();
                }
                return origFetch(input, init);
            };
        </script>
        <script>
            console.log('[DEBUG] index.html script block loaded at LINE 2571');
            function showHelpOverlay() {
                document.getElementById('help-overlay').style.display = 'block';
                document.getElementById('help-tooltip').style.display = 'none';
                // Remove any existing help circles
                const circlesContainer = document.getElementById('help-circles-container');
                circlesContainer.innerHTML = '';
                // Target 1: "i" pull-down (board menu dropdown), just to the left
                var menuDropdown = document.getElementById('board-menu-dropdown');
                if (menuDropdown && menuDropdown.style.display !== 'none') {
                    const rect = menuDropdown.getBoundingClientRect();
                    createHelpCircle(1, rect.left - 50, rect.top + rect.height / 2 - 20, true); // true = keep menu open
                }
                // Target 2: "Tell me what's going on..." input
                var input = document.querySelector('.add-thought textarea');
                if (input) {
                    const rect = input.getBoundingClientRect();
                    createHelpCircle(2, rect.left - 50, rect.top + rect.height / 2 - 20);
                }
                // Target 3: quadrants area, just to the left
                var quadrants = document.querySelector('.quadrants');
                if (quadrants) {
                    const rect = quadrants.getBoundingClientRect();
                    createHelpCircle(3, rect.left - 50, rect.top + rect.height / 2 - 20);
                }
            }
            function hideHelpOverlay() {
                document.getElementById('help-overlay').style.display = 'none';
                document.getElementById('help-tooltip').style.display = 'none';
                document.getElementById('help-circles-container').innerHTML = '';
            }
            function createHelpCircle(num, left, top, keepMenuOpen) {
                const circle = document.createElement('div');
                circle.className = 'help-circle';
                circle.textContent = num;
                circle.style.left = left + 'px';
                circle.style.top = top + 'px';
                circle.onclick = function (e) {
                    showHelpText(num, left, top);
                    if (keepMenuOpen) {
                        // Prevent menu from closing if clicking this help circle
                        e.stopPropagation();
                        if (e.preventDefault) e.preventDefault();
                        return false;
                    }
                };
                document.getElementById('help-circles-container').appendChild(circle);
            }
            function showHelpText(num, left, top) {
                const tooltip = document.getElementById('help-tooltip');
                let text = '';
                let offset = 60;
                if (num === 1) {
                    text = `<div style="display:flex;align-items:center;gap:12px;">
                  <span style='font-weight:600;'>Start with Interactive Mode to work directly with Gaps</span>
                  <div style='background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,0.08);min-width:160px;padding:8px 0;line-height:1.5;font-size:0.98em;'>
                    <div style='padding:8px 20px;color:#333;'>Open Board</div>
                    <div style='padding:8px 20px;color:#333;'>Create New Board</div>
                    <div style='padding:8px 20px;color:#333;'>Export Data</div>
                    <div style='padding:8px 20px;color:#333;'>Import Data</div>
                    <div style='padding:8px 20px;color:#c00;'>Delete Board</div>
                    <div style='padding:8px 20px;color:#007bff;'>Help</div>
                    <div style='padding:8px 20px;color:#333;'>Interactive mode</div>
                    <div style='border-top:1px solid #e5e5e5; margin:4px 0;'></div>
                    <div style='padding:8px 20px;color:#d9534f;'>Reset Conversation</div>
                    <div style='padding:8px 20px;color:#f0ad4e;'>Summarize Conversation</div>
                    <div style='padding:8px 20px;color:#5bc0de;'>Export Conversation Log</div>
<div id='export-cpf-btn' style='padding:8px 20px;color:#6c3cff;cursor:pointer;'>Export C.P.F.</div>
                  </div>
                </div>`;
                    offset = -260;
                } else if (num === 2) {
                    text = "You can manually add items to the quadrants here";
                    offset = 60;
                } else if (num === 3) {
                    text = "Use Interactive mode or manually populate the 4 quadrants with information about the issue you'd like help with. Move the items in the quadrants around so that they're in the appropriate quadrans";
                    offset = 60;
                }
                tooltip.innerHTML = text;
                tooltip.style.display = 'block';
                tooltip.style.left = (left + offset) + 'px';
                tooltip.style.top = (top - 10) + 'px';
            }

            window.addEventListener('scroll', function () {
                if (document.getElementById('help-overlay').style.display === 'block') {
                    showHelpOverlay();
                }
            });
            window.addEventListener('resize', function () {
                if (document.getElementById('help-overlay').style.display === 'block') {
                    showHelpOverlay();
                }
            });
        </script>

        <script>
            // Ensure getQuadrantListById is defined before Interactive Mode logic
            window.refreshQuadrants = async function() {
                const boardId = window.boardId;
                if (!boardId) return;
                try {
                    const resp = await fetch(`/get_quadrants?board_id=${boardId}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        ['status', 'goal', 'analysis', 'plan'].forEach(q => {
                            const ul = document.getElementById(`${q}-list`);
                            if (ul && Array.isArray(data[q])) {
                                ul.innerHTML = '';
                                data[q].forEach(thought => {
                                    const li = document.createElement('li');
                                    li.className = 'thought-item';
                                    li.innerHTML = `<span class="thought-content">${thought}</span>`;
                                    ul.appendChild(li);
                                });
                            }
                        });
                    }
                } catch (err) {
                    console.error('Failed to refresh quadrants:', err);
                }
            };

            window.getQuadrantListById = function(id) {
                console.log('[DEBUG] getQuadrantListById called with id:', id);
                const ul = document.getElementById(id);
                if (!ul) return [];
                return Array.from(ul.querySelectorAll('li .thought-content')).map(span => span.textContent.trim()).filter(Boolean);
            }
            console.log('[DEBUG] Interactive Mode script block loaded!');
            document.addEventListener('DOMContentLoaded', function () {
                console.log('[DEBUG] DOMContentLoaded - Interactive Mode script running');
                const interactiveGapsModal = document.getElementById('interactive-gaps-modal');
                const interactiveGapsLink = document.getElementById('interactive-gaps-link');
                const interactiveGapsClose = document.getElementById('interactive-gaps-close');
                const interactiveGapsSend = document.getElementById('interactive-gaps-send');
                const interactiveGapsInput = document.getElementById('interactive-gaps-input');
                const interactiveGapsChat = document.getElementById('interactive-gaps-chat');

                // --- Attach Interactive Mode SEND BUTTON handler ---
                if (interactiveGapsSend && interactiveGapsInput && interactiveGapsChat) {
                    console.log('[DEBUG] Attaching Interactive Mode send button handler');
                    interactiveGapsSend.addEventListener('click', async function () {
                        console.log('[DEBUG] Send button clicked');
                        const userMsg = interactiveGapsInput.value.trim();
                        if (!userMsg) return;
                        interactiveGapsChat.innerHTML += `<div><b>You:</b> ${userMsg}</div>`;
                        interactiveGapsInput.value = '';
                        interactiveGapsInput.focus();
                        // Gather current quadrants
                        const quadrants = {
                            status: typeof getQuadrantListById === 'function' ? getQuadrantListById('status-list') : [],
                            goal: typeof getQuadrantListById === 'function' ? getQuadrantListById('goal-list') : [],
                            analysis: typeof getQuadrantListById === 'function' ? getQuadrantListById('analysis-list') : [],
                            plan: typeof getQuadrantListById === 'function' ? getQuadrantListById('plan-list') : [],
                        };
                        const postData = {
                            board_id: window.boardId,
                            user_input: userMsg,
                            quadrants: quadrants
                        };
                        interactiveGapsChat.innerHTML += "<div style='color:#888; margin-bottom:0.7em;display:flex;align-items:center;gap:0.7em;'><span class='spinner' style='display:inline-block;width:18px;height:18px;border:2px solid #bbb;border-top:2px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;'></span> Waiting for AI response...</div>";
console.log('[DEBUG] POST payload to /interactive_gaps:', JSON.stringify(postData));
                        try {
                            const response = await fetch('/interactive_gaps', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                },
                                body: JSON.stringify(postData)
                            });
                            let data = null;
try {
    data = await response.json();
    console.log('[DEBUG] Backend response:', data);
} catch(parseErr) {
    const text = await response.text();
    console.error('[ERROR] Failed to parse JSON:', parseErr, text);
    interactiveGapsChat.innerHTML += `<div style='color:#c00;'>Error: Backend returned invalid JSON.<br><pre style='font-size:0.95em;color:#b00;background:#fff7f7;padding:0.5em;border-radius:5px;'>${text}</pre></div>`;
    return;
}
                            // Remove spinner before rendering AI response
const spinnerDiv = interactiveGapsChat.querySelector('.spinner')?.parentNode;
if (spinnerDiv) spinnerDiv.remove();
                            if (data && data.reply) {
                                interactiveGapsChat.innerHTML += `<div style='margin-top:0.7em;color:#007bff;'><b>AI:</b> ${data.reply.replace(/\n/g, '<br>')}</div>`;
                                interactiveGapsChat.scrollTop = interactiveGapsChat.scrollHeight;
                            }
                            // Suggestions UI
                            if (data.suggestions && Array.isArray(data.suggestions.add_to_quadrant)) {
                                let sugHtml = '<div class="ai-suggest-label" style="margin:0.7em 0 0.2em 0;font-weight:bold;color:#007bff;">AI suggests adding the following:</div>';
                                data.suggestions.add_to_quadrant.forEach(function (item, idx) {
                                    if (item.quadrant && item.thought) {
                                        const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                                        sugHtml += `<div style='margin-bottom:0.3em;padding:0.3em 0.5em;background:#f5faff;border-radius:6px;'>\n <span style='color:#007bff;font-weight:bold;'>${item.quadrant.charAt(0).toUpperCase() + item.quadrant.slice(1)}:</span>\n <span class='ai-suggested-thought'>${item.thought}</span>\n <button id='${btnId}' style='margin-left:0.7em;font-size:0.95em;padding:0.2em 0.7em;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;'>Add to Quadrant</button>\n </div>`;
                                        setTimeout(() => {
                                            const btn = document.getElementById(btnId);
                                            if (btn) {
                                                btn.addEventListener('click', async function () {
                                                    const boardId = window.boardId || null;
                                                    if (!boardId) {
                                                        alert('No board selected.');
                                                        return;
                                                    }
                                                    try {
                                                        const resp = await fetch('/add_thought', {
                                                            method: 'POST',
                                                            headers: {
                                                                'Content-Type': 'application/json',
                                                                'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                                            },
                                                            body: JSON.stringify({
                                                                content: item.thought,
                                                                quadrant: item.quadrant,
                                                                board_id: boardId
                                                            })
                                                        });
                                                        const result = await resp.json();
                                                        if (result.success) {
                                                            if (typeof window.refreshQuadrants === 'function') {
                                                                window.refreshQuadrants();
                                                            }
                                                            btn.disabled = true;
                                                            btn.textContent = 'Added!';
                                                            btn.style.background = '#5cb85c';
                                                            btn.style.color = '#fff';
                                                            if (typeof showNotification === 'function') {
                                                                showNotification('Thought added to ' + item.quadrant + '!', false);
                                                            }
                                                        } else {
                                                            alert('Failed to save thought: ' + (result.error || 'Unknown error'));
                                                        }
                                                    } catch (err) {
                                                        alert('Error saving thought: ' + err.message);
                                                    }
                                                });
                                            }
                                        }, 0);
                                    }
                                });
                                // Insert below the chat window
                                let sugBox = document.getElementById('ai-suggestion-box');
                                if (!sugBox) {
                                    sugBox = document.createElement('div');
                                    sugBox.id = 'ai-suggestion-box';
                                    interactiveGapsChat.parentNode.insertBefore(sugBox, interactiveGapsChat.nextSibling);
                                }
                                // Clean up stray newlines and excess whitespace
sugHtml = sugHtml.replace(/\n/g, '').replace(/\s{2,}/g, ' ');
sugBox.innerHTML = sugHtml;
                                sugBox.style.display = 'block';
                            }
                        } catch (err) {
                            interactiveGapsChat.innerHTML = "<div style='color:#c00;'>Error contacting AI. Please try again.</div>";
                        }
                    });
                    // Enter key triggers send (without Shift)
                    interactiveGapsInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            interactiveGapsSend.click();
                        }
                    });
                }

                // Attach close, minimize, and restore event listeners
                if (interactiveGapsClose) {
                    interactiveGapsClose.addEventListener('click', function() {
                        interactiveGapsModal.style.display = 'none';
                    });
                }
                const interactiveGapsMinimize = document.getElementById('interactive-gaps-minimize');
                const interactiveGapsRestoreBar = document.getElementById('interactive-gaps-restore-bar');
                const interactiveGapsRestore = document.getElementById('interactive-gaps-restore');
                // Remove all duplicate listeners, only use this block for minimize/restore
                if (interactiveGapsMinimize && interactiveGapsRestoreBar && interactiveGapsRestore) {
                    interactiveGapsMinimize.addEventListener('click', function() {
                        console.log('[DEBUG] Minimize button clicked');
                        interactiveGapsModal.style.display = 'none';
                        // Set all critical styles to guarantee visibility
                        interactiveGapsRestoreBar.style.display = 'flex';
                        console.log('[DEBUG] Set restore bar display:flex on minimize');
                        interactiveGapsRestoreBar.style.position = 'fixed';
                        interactiveGapsRestoreBar.style.bottom = '20px';
                        interactiveGapsRestoreBar.style.left = '20px';
                        interactiveGapsRestoreBar.style.zIndex = 3100;
                        interactiveGapsRestoreBar.style.background = '#fff';
                        interactiveGapsRestoreBar.style.borderRadius = '6px';
                        interactiveGapsRestoreBar.style.boxShadow = '0 2px 8px rgba(0,0,0,0.10)';
                        interactiveGapsRestoreBar.style.padding = '0.5em 1em';
                        interactiveGapsRestoreBar.style.alignItems = 'center';
                        interactiveGapsRestoreBar.style.gap = '0.7em';
                        setTimeout(() => {
                            console.log('[DEBUG] Restore bar present after minimize:', !!document.getElementById('interactive-gaps-restore-bar'));
                            // DEBUG: force restore bar to be visible and on top
                            interactiveGapsRestoreBar.style.zIndex = 99999;
                            interactiveGapsRestoreBar.style.border = '3px solid red';
                            interactiveGapsRestoreBar.style.opacity = '1';
                            interactiveGapsRestoreBar.style.pointerEvents = 'auto';
                            interactiveGapsRestoreBar.style.visibility = 'visible';
                        }, 100);
                        // Log computed style and DOM presence
                        console.log('[DEBUG] Restore bar DOM:', interactiveGapsRestoreBar);
                        console.log('[DEBUG] Restore bar computed display:', window.getComputedStyle(interactiveGapsRestoreBar).display);
                    });
                    interactiveGapsRestore.addEventListener('click', function() {
                        interactiveGapsModal.style.display = 'flex';
                        interactiveGapsRestoreBar.style.display = 'none';
                    });
                }

                if (interactiveGapsLink) {
                    console.log('[DEBUG] interactiveGapsLink found at DOMContentLoaded');
                    interactiveGapsLink.addEventListener('click', function (e) {
                        console.log('[DEBUG] Interactive mode link clicked');
                        e.preventDefault();
                        if (!interactiveGapsModal) {
                            console.log('[DEBUG] interactiveGapsModal is null!');
                        } else {
                            interactiveGapsModal.style.display = 'flex';
                            console.log('[DEBUG] Modal display set to flex');
                        }
                        // Gather current quadrants
                        console.log('[DEBUG] typeof getQuadrantListById:', typeof getQuadrantListById);
                        const statusList = getQuadrantListById('status-list');
                        const goalList = getQuadrantListById('goal-list');
                        const analysisList = getQuadrantListById('analysis-list');
                        const planList = getQuadrantListById('plan-list');
                        console.log('[DEBUG] statusList:', statusList);
                        console.log('[DEBUG] goalList:', goalList);
                        console.log('[DEBUG] analysisList:', analysisList);
                        console.log('[DEBUG] planList:', planList);
                        const quadrants = {
                            status: statusList,
                            goal: goalList,
                            analysis: analysisList,
                            plan: planList,
                        };

                        console.log('[DEBUG] Quadrants on modal open:', quadrants);
                        const allEmpty = Object.values(quadrants).every(arr => arr.length === 0);
                        // Remove hardcoded onboarding/prior work message. Let the AI handle onboarding from the prompt.
                        // Always trigger AI fetch regardless of quadrant state
                        let user_input, postData;
                        if (allEmpty) {
                            // Empty board: onboarding
                            user_input = 'The GAPS quadrants are currently empty. Please help me get started by first asking what problem, challenge, or topic I want to work on, and then guide me step by step through the GAPS process.';
                            postData = {
                                board_id: window.boardId,
                                user_input: user_input
                            };
                        } else {
                            // Non-empty board: kickoff prompt for quadrant-aware summary
                            user_input = '';
                            postData = {
                                board_id: window.boardId,
                                user_input: user_input,
                                quadrants: quadrants
                            };
                        }
                        console.log('[DEBUG] interactiveGapsChat:', interactiveGapsChat);
                        if (!interactiveGapsChat) {
                            console.error('[ERROR] interactiveGapsChat element not found!');
                            return;
                        }
                        console.log('[DEBUG] About to fetch /interactive_gaps', postData);
                        interactiveGapsChat.innerHTML = "<div style='color:#888; margin-bottom:0.7em;display:flex;align-items:center;gap:0.7em;'><span class='spinner' style='display:inline-block;width:18px;height:18px;border:2px solid #bbb;border-top:2px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;'></span> Waiting for AI response...</div>";
                        fetch('/interactive_gaps', {
                            // --- DEBUG: FETCH 756 CALLED ---
                            // --- DEBUG: HANDLER 1 fetch called ---
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                            },
                            body: JSON.stringify(postData)
                        })
                            .then(response => response.json())
                            .then(data => {
                                // --- Remove spinner/waiting message if present ---
                                const spinnerDiv = interactiveGapsChat.querySelector('.spinner')?.parentNode;
                                if (spinnerDiv) spinnerDiv.remove();

                                // Remove any existing suggestion box inside the chat window
                                const oldSugBox = interactiveGapsChat.querySelector('#ai-suggestion-box');
                                if (oldSugBox && oldSugBox.parentNode) {
                                    oldSugBox.parentNode.removeChild(oldSugBox);
                                }

                                // Normalize suggestions data
                                let suggestions = [];
                                if (data.suggestions && Array.isArray(data.suggestions.add_to_quadrant)) {
                                    suggestions = data.suggestions.add_to_quadrant;
                                } else if (Array.isArray(data.suggestions)) {
                                    suggestions = data.suggestions;
                                }

                                if (suggestions.length > 0) {
    suggestionRenderCount++;
                                    let sugHtml = '<div class="ai-suggest-label" style="margin:0.7em 0 0.2em 0;font-weight:bold;color:#007bff;">AI suggests adding the following:</div>';
                                    suggestions.forEach(function (item, idx) {
                                        if (item.quadrant && item.thought) {
                                            const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                                            sugHtml += `<div style='margin-bottom:0.3em;padding:0.3em 0.5em;background:#f5faff;border-radius:6px;'><span style='color:#007bff;font-weight:bold;'>${item.quadrant.charAt(0).toUpperCase() + item.quadrant.slice(1)}:</span> <span class='ai-suggested-thought'>${item.thought}</span> <button id='${btnId}' style='margin-left:0.7em;font-size:0.95em;padding:0.2em 0.7em;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;'>Add to Quadrant</button></div>`;
                                        }
                                    });
                                    suggestionHtml = `<div id="ai-suggestion-box">${sugHtml}</div>`;
                                }
                                let replyHtml = '';
                                if (data && data.reply) {
                                    replyHtml = `<div style='margin-top:0.7em;color:#007bff;'><b>AI:</b> ${data.reply.replace(/\n/g, '<br>')}</div>`;
                                }
                                // Append suggestion box and AI reply together (suggestions first)
                                interactiveGapsChat.innerHTML += suggestionHtml + replyHtml;
                                interactiveGapsChat.scrollTop = interactiveGapsChat.scrollHeight;

                                // Attach click handlers directly (after DOM update)
                                suggestions.forEach(function (item, idx) {
                                    if (item.quadrant && item.thought) {
                                        const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                                        // Use querySelectorAll to get all matching buttons (in case of duplicate ids)
                                        const btns = interactiveGapsChat.querySelectorAll(`#${btnId}`);
                                        btns.forEach(function (btn) {
                                            btn.addEventListener('click', async function () {
                                                const boardId = window.boardId || null;
                                                if (!boardId) {
                                                    alert('No board selected.');
                                                    return;
                                                }
                                                btn.disabled = true;
                                                btn.textContent = 'Adding...';
                                                try {
                                                    const resp = await fetch('/add_thought', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                            'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                                        },
                                                        body: JSON.stringify({
                                                            content: item.thought,
                                                            quadrant: item.quadrant,
                                                            board_id: boardId
                                                        })
                                                    });
                                                    const result = await resp.json();
                                                    if (result.success) {
                                                        if (typeof window.refreshQuadrants === 'function') {
                                                            window.refreshQuadrants();
                                                        }
                                                        btn.disabled = true;
                                                        btn.textContent = 'Added!';
                                                        btn.style.background = '#5cb85c';
                                                        btn.style.color = '#fff';
                                                        if (typeof showNotification === 'function') {
                                                            showNotification('Thought added to ' + item.quadrant + '!', false);
                                                        }
                                                    } else {
                                                        btn.disabled = false;
                                                        btn.textContent = 'Add to Quadrant';
                                                        alert('Failed to save thought: ' + (result.error || 'Unknown error'));
                                                    }
                                                } catch (err) {
                                                    btn.disabled = false;
                                                    btn.textContent = 'Add to Quadrant';
                                                    alert('Error saving thought: ' + err.message);
                                                }
                                            });
                                        });
                                    }
                                });          });
                                }
                            })
                            .catch(err => {
                                interactiveGapsChat.innerHTML = "<div style='color:#c00;'>Error contacting AI. Please try again.</div>";
                            });
                        interactiveGapsInput.value = '';
                        interactiveGapsInput.focus();
                    });
                } else {
                    console.log('[DEBUG] interactiveGapsLink not found at DOMContentLoaded');
                }
            });
        // --- Export C.P.F. download handler for board-menu-dropdown ---
    document.addEventListener('DOMContentLoaded', function () {
    console.log('[DEBUG] DOMContentLoaded fired for Export C.P.F.');
    var cpfMenuLink = document.getElementById('export-cpf-link');
    console.log('[DEBUG] cpfMenuLink:', cpfMenuLink);
    if (cpfMenuLink) {
        cpfMenuLink.addEventListener('click', function (e) {
            console.log('[DEBUG] Export C.P.F. clicked');
            e.preventDefault();
            fetch('/prompts/prompts_modified.txt', {method: 'GET'})
                .then(response => {
                    if (response.ok) {
                        response.blob().then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = 'prompts_modified.txt';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        });
                    } else {
                        alert('C.P.F. file not found on server.');
                    }
                })
                .catch(() => {
                    alert('C.P.F. file not found on server.');
                });
        });
    } else {
        console.log('[DEBUG] export-cpf-link NOT FOUND at DOMContentLoaded');
    }
});
        }
    });
</script>
    <div id="interactive-gaps-restore-bar"
        style="display:none;position:fixed;left:20px;bottom:20px;z-index:3100;background:#fff;border-radius:8px;padding:0.7em 1.4em;box-shadow:0 2px 8px rgba(0,0,0,0.12);color:#007bff;cursor:pointer;align-items:center;gap:0.7em;min-width:180px;max-width:320px;justify-content:space-between;">
        <span style="font-weight:bold;">Interactive GAPS</span>
        <button id="interactive-gaps-restore" title="Restore"
            style="background:none;border:none;font-size:1.2em;cursor:pointer;color:#007bff;">&#9633;</button>
    </div>
    <script>
    // Global counter for stable suggestion button IDs
    let suggestionRenderCount = 0;
    document.addEventListener('DOMContentLoaded', function() {
        const interactiveGapsModal = document.getElementById('interactive-gaps-modal');
        const interactiveGapsLink = document.getElementById('interactive-gaps-link');
        const interactiveGapsClose = document.getElementById('interactive-gaps-close');
        const interactiveGapsSend = document.getElementById('interactive-gaps-send');
        const interactiveGapsInput = document.getElementById('interactive-gaps-input');
        const interactiveGapsMinimize = document.getElementById('interactive-gaps-minimize');
        const interactiveGapsRestoreBar = document.getElementById('interactive-gaps-restore-bar');
        const interactiveGapsModalContent = document.getElementById('interactive-gaps-modal-content');

        // Minimize button handler
        if (interactiveGapsMinimize && interactiveGapsModal && interactiveGapsRestoreBar && interactiveGapsModalContent) {
            interactiveGapsMinimize.addEventListener('click', function() {
                interactiveGapsModalContent.style.display = 'none';
                interactiveGapsRestoreBar.style.display = 'flex';
                interactiveGapsModal.style.background = 'transparent';
            });
            // Restore bar handler
            interactiveGapsRestoreBar.addEventListener('click', function() {
                interactiveGapsModalContent.style.display = '';
                interactiveGapsRestoreBar.style.display = 'none';
                interactiveGapsModal.style.background = 'rgba(0,0,0,0.35)';
            });
        }
        // Close button handler
        if (interactiveGapsClose && interactiveGapsModal) {
            interactiveGapsClose.addEventListener('click', function() {
                interactiveGapsModal.style.display = 'none';
                interactiveGapsModalContent.style.display = '';
                interactiveGapsRestoreBar.style.display = 'none';
                interactiveGapsModal.style.background = 'rgba(0,0,0,0.35)';
                // Optionally clear chat/input
                const interactiveGapsChat = document.getElementById('interactive-gaps-chat');
                if (interactiveGapsChat) interactiveGapsChat.innerHTML = '';
                if (interactiveGapsInput) interactiveGapsInput.value = '';
            });
        }
        const interactiveGapsChat = document.getElementById('interactive-gaps-chat');
        // --- Interactive Mode SEND HANDLERS ---
        if (interactiveGapsSend && interactiveGapsInput) {
            // Send on button click
            interactiveGapsSend.addEventListener('click', sendInteractiveGapsMessage);
            // Send on Enter key in input
            interactiveGapsInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    sendInteractiveGapsMessage();
                }
            });
        }
        function sendInteractiveGapsMessage() {
            const userMsg = interactiveGapsInput.value.trim();
            if (!userMsg) return;
            // Gather quadrants
            const quadrants = {
                status: getQuadrantListById('status-list'),
                goal: getQuadrantListById('goal-list'),
                analysis: getQuadrantListById('analysis-list'),
                plan: getQuadrantListById('plan-list'),
            };
            const postData = {
                board_id: window.boardId,
                user_input: userMsg,
                quadrants: quadrants
            };
            // Show spinner
            interactiveGapsChat.innerHTML += "<div style='color:#888;margin-bottom:0.7em;display:flex;align-items:center;gap:0.7em;'><span class='spinner' style='display:inline-block;width:18px;height:18px;border:2px solid #bbb;border-top:2px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;'></span> Waiting for AI response...</div>";
            interactiveGapsInput.value = '';
            interactiveGapsInput.focus();
            fetch('/interactive_gaps', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                },
                body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('[DEBUG] /interactive_gaps response:', data);
                // Remove spinner
                const spinnerDiv = interactiveGapsChat.querySelector('.spinner')?.parentNode;
                if (spinnerDiv) spinnerDiv.remove();
                // Remove any previous error message
                const prevError = interactiveGapsChat.querySelector('.ai-error-message');
                if (prevError) prevError.remove();
                // Render AI reply and suggestions (reuse your existing rendering logic)
                let suggestionHtml = '';
                let suggestions = [];
                if (data && data.suggestions && Array.isArray(data.suggestions.add_to_quadrant)) {
                    suggestions = data.suggestions.add_to_quadrant;
                } else if (data && Array.isArray(data.suggestions)) {
                    suggestions = data.suggestions;
                } else {
                    suggestions = [];
                }
                console.log('[DEBUG] SUGGESTIONS EXTRACTED:', suggestions);
                if (suggestions.length > 0) {
                    suggestionRenderCount++;
                    let sugHtml = '<div class="ai-suggest-label" style="margin:0.7em 0 0.2em 0;font-weight:bold;color:#007bff;">AI suggests adding the following:</div>';
                    suggestions.forEach(function (item, idx) {
                        if (item.quadrant && item.thought) {
                            const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                            sugHtml += `<div style='margin-bottom:0.3em;padding:0.3em 0.5em;background:#f5faff;border-radius:6px;'><span style='color:#007bff;font-weight:bold;'>${item.quadrant.charAt(0).toUpperCase() + item.quadrant.slice(1)}:</span> <span class='ai-suggested-thought'>${item.thought}</span> <button id='${btnId}' style='margin-left:0.7em;font-size:0.95em;padding:0.2em 0.7em;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;'>Add to Quadrant</button></div>`;
                        }
                    });
                    suggestionHtml = `<div id=\"ai-suggestion-box\">${sugHtml}</div>`;
                }
                let replyHtml = '';
                if (data && data.reply) {
                    replyHtml = `<div style='margin-top:0.7em;color:#007bff;'><b>AI:</b> ${data.reply.replace(/\n/g, '<br>')}</div>`;
                }
                interactiveGapsChat.innerHTML += suggestionHtml + replyHtml;
                interactiveGapsChat.scrollTop = interactiveGapsChat.scrollHeight;
                // Attach click handlers for new suggestions (reuse your existing logic)
                suggestions.forEach(function (item, idx) {
                    if (item.quadrant && item.thought) {
                        const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                        const btns = interactiveGapsChat.querySelectorAll(`#${btnId}`);
                        btns.forEach(function (btn) {
                            btn.addEventListener('click', async function () {
                                const boardId = window.boardId || null;
                                if (!boardId) {
                                    alert('No board selected.');
                                    return;
                                }
                                btn.disabled = true;
                                btn.textContent = 'Adding...';
                                try {
                                    const resp = await fetch('/add_thought', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                        },
                                        body: JSON.stringify({
                                            content: item.thought,
                                            quadrant: item.quadrant,
                                            board_id: boardId
                                        })
                                    });
                                    const result = await resp.json();
                                    if (result.success) {
                                        if (typeof window.refreshQuadrants === 'function') {
                                            window.refreshQuadrants();
                                        }
                                        btn.disabled = true;
                                        btn.textContent = 'Added!';
                                        btn.style.background = '#5cb85c';
                                        btn.style.color = '#fff';
                                        if (typeof showNotification === 'function') {
                                            showNotification('Thought added to ' + item.quadrant + '!', false);
                                        }
                                    } else {
                                        btn.disabled = false;
                                        btn.textContent = 'Add to Quadrant';
                                        alert('Failed to save thought: ' + (result.error || 'Unknown error'));
                                    }
                                } catch (err) {
                                    btn.disabled = false;
                                    btn.textContent = 'Add to Quadrant';
                                    alert('Error saving thought: ' + err.message);
                                }
                            });
                        });
                    }
                });
            })
            .catch(err => {
                console.error('[AI FETCH ERROR]', err);
                // Remove any previous error message
                const prevError = interactiveGapsChat.querySelector('.ai-error-message');
                if (prevError) prevError.remove();
                interactiveGapsChat.innerHTML += "<div class='ai-error-message' style='color:#c00;'>Error contacting AI. Please try again.<br><span style='font-size:0.9em;color:#888;'>" + (err && err.message ? err.message : err) + "</span></div>";
            });
        }

        if (interactiveGapsLink) {
            console.log('[DEBUG] interactiveGapsLink found at DOMContentLoaded');
            interactiveGapsLink.addEventListener('click', function(e) {
                console.log('[DEBUG] Interactive mode link clicked');
                e.preventDefault();
                if (!interactiveGapsModal) {
                    console.log('[DEBUG] interactiveGapsModal is null!');
                    return;
                }
                interactiveGapsModal.style.display = 'flex';
                suggestionRenderCount = 0; // Reset on modal open
                console.log('[DEBUG] Modal display set to flex');

                // Gather current quadrants
                const statusList = getQuadrantListById('status-list');
                const goalList = getQuadrantListById('goal-list');
                const analysisList = getQuadrantListById('analysis-list');
                const planList = getQuadrantListById('plan-list');
                const quadrants = {
                    status: statusList,
                    goal: goalList,
                    analysis: analysisList,
                    plan: planList,
                };
                console.log('[DEBUG] Quadrants on modal open:', quadrants);
                const allEmpty = Object.values(quadrants).every(arr => arr.length === 0);
                let user_input, postData;
                if (allEmpty) {
                    user_input = 'The GAPS quadrants are currently empty. Please help me get started by first asking what problem, challenge, or topic I want to work on, and then guide me step by step through the GAPS process.';
                    postData = {
                        board_id: window.boardId,
                        user_input: user_input
                    };
                } else {
                    user_input = '';
                    postData = {
                        board_id: window.boardId,
                        user_input: user_input,
                        quadrants: quadrants
                    };
                }
                if (!interactiveGapsChat) {
                    console.error('[ERROR] interactiveGapsChat element not found!');
                    return;
                }
                console.log('[DEBUG] About to fetch /interactive_gaps', postData);
                interactiveGapsChat.innerHTML = "<div style='color:#888; margin-bottom:0.7em;display:flex;align-items:center;gap:0.7em;'><span class='spinner' style='display:inline-block;width:18px;height:18px;border:2px solid #bbb;border-top:2px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;'></span> Waiting for AI response...</div>";
                fetch('/interactive_gaps', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                    },
                    body: JSON.stringify(postData)
                })
                .then(response => response.json())
                .then(data => {
                    // Remove spinner/waiting message if present
                    const spinnerDiv = interactiveGapsChat.querySelector('.spinner')?.parentNode;
                    if (spinnerDiv) spinnerDiv.remove();
                    // Remove any existing suggestion box inside the chat window
                    const oldSugBox = interactiveGapsChat.querySelector('#ai-suggestion-box');
                    if (oldSugBox && oldSugBox.parentNode) {
                        oldSugBox.parentNode.removeChild(oldSugBox);
                    }
                    // Normalize suggestions data
                    let suggestions = [];
                    if (data.suggestions && Array.isArray(data.suggestions.add_to_quadrant)) {
                        suggestions = data.suggestions.add_to_quadrant;
                    } else if (Array.isArray(data.suggestions)) {
                        suggestions = data.suggestions;
                    }
                    let suggestionHtml = '';
                    if (suggestions.length > 0) {
    suggestionRenderCount++;
                        let sugHtml = '<div class="ai-suggest-label" style="margin:0.7em 0 0.2em 0;font-weight:bold;color:#007bff;">AI suggests adding the following:</div>';
                        suggestions.forEach(function (item, idx) {
                            if (item.quadrant && item.thought) {
                                const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                                sugHtml += `<div style='margin-bottom:0.3em;padding:0.3em 0.5em;background:#f5faff;border-radius:6px;'><span style='color:#007bff;font-weight:bold;'>${item.quadrant.charAt(0).toUpperCase() + item.quadrant.slice(1)}:</span> <span class='ai-suggested-thought'>${item.thought}</span> <button id='${btnId}' style='margin-left:0.7em;font-size:0.95em;padding:0.2em 0.7em;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;'>Add to Quadrant</button></div>`;
                            }
                        });
                        suggestionHtml = `<div id="ai-suggestion-box">${sugHtml}</div>`;
                    }
                    let replyHtml = '';
                    if (data && data.reply) {
                        replyHtml = `<div style='margin-top:0.7em;color:#007bff;'><b>AI:</b> ${data.reply.replace(/\n/g, '<br>')}</div>`;
                    }
                    // Append suggestion box and AI reply together (suggestions first)
                    interactiveGapsChat.innerHTML += suggestionHtml + replyHtml;
                    interactiveGapsChat.scrollTop = interactiveGapsChat.scrollHeight;
                    // Attach click handlers directly (after DOM update)
                    suggestions.forEach(function (item, idx) {
                        if (item.quadrant && item.thought) {
                            const btnId = `add-to-quadrant-btn-${suggestionRenderCount}-${idx}`;
                            const btns = interactiveGapsChat.querySelectorAll(`#${btnId}`);
                            btns.forEach(function (btn) {
                                btn.addEventListener('click', async function () {
                                    const boardId = window.boardId || null;
                                    if (!boardId) {
                                        alert('No board selected.');
                                        return;
                                    }
                                    btn.disabled = true;
                                    btn.textContent = 'Adding...';
                                    try {
                                        const resp = await fetch('/add_thought', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': (typeof getCsrfToken === 'function') ? getCsrfToken() : ''
                                            },
                                            body: JSON.stringify({
                                                content: item.thought,
                                                quadrant: item.quadrant,
                                                board_id: boardId
                                            })
                                        });
                                        const result = await resp.json();
                                        if (result.success) {
                                            if (typeof window.refreshQuadrants === 'function') {
                                                window.refreshQuadrants();
                                            }
                                            btn.disabled = true;
                                            btn.textContent = 'Added!';
                                            btn.style.background = '#5cb85c';
                                            btn.style.color = '#fff';
                                            if (typeof showNotification === 'function') {
                                                showNotification('Thought added to ' + item.quadrant + '!', false);
                                            }
                                        } else {
                                            btn.disabled = false;
                                            btn.textContent = 'Add to Quadrant';
                                            alert('Failed to save thought: ' + (result.error || 'Unknown error'));
                                        }
                                    } catch (err) {
                                        btn.disabled = false;
                                        btn.textContent = 'Add to Quadrant';
                                        alert('Error saving thought: ' + err.message);
                                    }
                                });
                            });
                        }
                    });
                })
                .catch(err => {
                    interactiveGapsChat.innerHTML = "<div style='color:#c00;'>Error contacting AI. Please try again.</div>";
                });
                interactiveGapsInput.value = '';
                interactiveGapsInput.focus();
            });
        } else {
            console.log('[DEBUG] interactiveGapsLink NOT found at DOMContentLoaded');
        }
    });
    </script>
</body>
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('[DEBUG] DOMContentLoaded fired for Export C.P.F.');
    var cpfMenuLink = document.getElementById('export-cpf-link');
    console.log('[DEBUG] cpfMenuLink:', cpfMenuLink);
    if (cpfMenuLink) {
        cpfMenuLink.addEventListener('click', function (e) {
            console.log('[DEBUG] Export C.P.F. clicked');
            e.preventDefault();
            fetch('/prompts/prompts_modified.txt', {method: 'GET'})
                .then(response => {
                    if (response.ok) {
                        response.blob().then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = 'prompts_modified.txt';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        });
                    } else {
                        alert('C.P.F. file not found on server.');
                    }
                })
                .catch(() => {
                    alert('C.P.F. file not found on server.');
                });
        });
    } else {
        console.log('[DEBUG] export-cpf-link NOT FOUND at DOMContentLoaded');
    }
});
</script>
</html>